<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MR. WASH | Drăgănești-Olt</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Plus+Jakarta+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --emerald-glow: rgba(16, 185, 129, 0.4);
            --glass-bg: rgba(10, 10, 10, 0.9);
            --border-glow: rgba(255, 255, 255, 0.1);
        }

        body { 
            background-color: #000000; 
            color: #ffffff; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
            height: 100vh;
        }

        .luxury-bg { 
            background: 
                radial-gradient(circle at 50% -20%, #064e3b 0%, transparent 60%),
                radial-gradient(circle at 100% 100%, #051a14 0%, transparent 30%),
                #000000;
            height: 100vh;
            display: flex; 
            flex-direction: column; 
        }

        .glass-panel { 
            background: var(--glass-bg); 
            backdrop-filter: blur(30px) saturate(200%); 
            border: 1px solid var(--border-glow);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.9);
        }

        .font-outfit { font-family: 'Outfit', sans-serif; }

        /* Jetoniera Ultra-Realistă */
        .coin-slot-container {
            position: relative;
            width: 140px;
            height: 180px;
            margin: 0 auto;
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            border-radius: 20px;
            border: 2px solid #333;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,1),
                0 10px 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .coin-entry {
            width: 14px;
            height: 90px;
            background: #000;
            border-radius: 10px;
            border: 2px solid #222;
            box-shadow: 
                inset 0 0 10px rgba(16, 185, 129, 0.2),
                0 0 15px rgba(16, 185, 129, 0.1);
            position: relative;
            overflow: hidden;
        }

        .coin-entry::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
        }

        .active-glow {
            box-shadow: 
                inset 0 0 15px var(--emerald-glow),
                0 0 25px var(--emerald-glow);
            border-color: #10b981;
        }

        @keyframes coin-insert {
            0% { transform: translateY(-20px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(40px); opacity: 0; }
        }
        .coin-animation {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #fbbf24, #b45309);
            border-radius: 50%;
            border: 2px solid #78350f;
            z-index: 50;
            animation: coin-insert 0.5s ease-in forwards;
        }

        @keyframes pulse-emerald { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
        .scan-pulse { animation: pulse-emerald 2s infinite; }

        .btn-premium {
            background: #ffffff;
            color: #000000;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }
        .btn-premium:active { transform: scale(0.96); }

        .token-counter {
            font-size: 3.5rem;
            font-weight: 900;
            font-family: 'Outfit', sans-serif;
            font-style: italic;
            line-height: 1;
            background: linear-gradient(to bottom, #fff, #666);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, set, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlzoN9-l_Gvk3ZV2sERlRNQux5QdoSYi4",
            authDomain: "premium-car-wash-systems.firebaseapp.com",
            projectId: "premium-car-wash-systems",
            storageBucket: "premium-car-wash-systems.appspot.com",
            messagingSenderId: "1066804021666",
            appId: "1:1066804021666:web:9494cf947ea14502758afb",
            databaseURL: "https://premium-car-wash-systems-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const auth = getAuth(app);

        const appId = 'premium-car-wash'; 
        const COLLECTION_NAME = 'loyalty';
        const TOKENS_PER_STAMP = 5; 
        const LOCATION_NAME = "Drăgănești-Olt";
        const weatherApiKey = "5b6ddfa16f49e0e7b271b69d374d902f";

        const SOUNDS = {
            COIN: "https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3",
            SUCCESS: "https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"
        };

        const urlParams = new URLSearchParams(window.location.search);
        const CURRENT_BOX_ID = urlParams.get('box') || "OLT_BOX_01"; 

        const Icon = ({ name, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                    window.lucide.createIcons({ portal: containerRef.current });
                }
            }, [name, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center pointer-events-none" />;
        };

        function App() {
            const [view, setView] = useState('auth');
            const [plate, setPlate] = useState(localStorage.getItem('pws_plate') || '');
            const [phone, setPhone] = useState(localStorage.getItem('pws_phone') || '');
            const [loading, setLoading] = useState(false);
            const [boxStatus, setBoxStatus] = useState('...');
            const [userStats, setUserStats] = useState({ visits: 0, nextIsFree: false });
            const [sessionProgress, setSessionProgress] = useState(0);
            const [hasStampInSession, setHasStampInSession] = useState(false);
            const [showStampSuccess, setShowStampSuccess] = useState(false);
            const [user, setUser] = useState(null);
            const [weatherData, setWeatherData] = useState(null);
            const [isTestMode, setIsTestMode] = useState(false);
            const [isAnimatingCoin, setIsAnimatingCoin] = useState(false);

            const isProcessingToken = useRef(false);
            const audioEnabled = useRef(false);

            const playSound = (type) => {
                if (!audioEnabled.current) return;
                try {
                    const audio = new Audio(SOUNDS[type]);
                    audio.volume = 0.5;
                    audio.play().catch(() => {});
                } catch (e) {}
            };

            const fetchWeather = async () => {
                try {
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=44.17&lon=24.53&units=metric&lang=ro&appid=${weatherApiKey}`);
                    const data = await response.json();
                    if (data && data.list) {
                        setWeatherData([data.list[0], data.list[8]].map(day => ({
                            temp: Math.round(day.main.temp),
                            rain: day.weather[0].main.toLowerCase().includes('rain')
                        })));
                    }
                } catch (e) {
                    setWeatherData([{ temp: 4, rain: false }, { temp: 6, rain: false }]);
                }
            };

            const refreshStats = async (targetPlate) => {
                if (!auth.currentUser) return;
                try {
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    const q = query(colPath, where("numarInmatriculare", "==", targetPlate.toUpperCase().trim()));
                    const snap = await getDocs(q);
                    const allDocs = snap.docs.map(d => ({...d.data(), ts: d.data().timestamp?.toDate()?.getTime() || Date.now()}));
                    const stamps = allDocs.filter(d => d.type === 'visit_stamp' && d.status === 'completed');
                    const count = stamps.length % 5;
                    const lastStampTime = stamps.sort((a,b) => b.ts - a.ts)[0]?.ts || 0;
                    const sessionWindow = isTestMode ? (10 * 1000) : (30 * 60 * 1000);
                    const recentStamp = stamps.some(d => (Date.now() - d.ts) < sessionWindow);
                    setHasStampInSession(recentStamp);
                    const progress = allDocs.filter(d => d.type === 'extra_token_log' && d.ts > lastStampTime && (Date.now() - d.ts) < sessionWindow).length;
                    setSessionProgress(progress);
                    setUserStats({ visits: count, nextIsFree: count === 4 });
                } catch (err) { console.error(err); }
            };

            const handleLogin = async (e) => {
                if (e) e.preventDefault();
                if (!plate.trim() || !phone.trim() || !user) return;
                localStorage.setItem('pws_plate', plate.toUpperCase());
                localStorage.setItem('pws_phone', phone);
                audioEnabled.current = true;
                setLoading(true);
                try {
                    await refreshStats(plate.toUpperCase().replace(/\s/g, ''));
                    setView('dashboard');
                } finally { setLoading(false); }
            };

            const handleRedeem = async () => {
                setLoading(true);
                try {
                    await set(ref(rtdb, `artifacts/${appId}/public/data/control/${CURRENT_BOX_ID}/inject_tokens`), 4);
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    const q = query(colPath, where("numarInmatriculare", "==", plate.toUpperCase()));
                    const snap = await getDocs(q);
                    for (const doc of snap.docs) await deleteDoc(doc.ref);
                    playSound('SUCCESS');
                    setTimeout(() => { setView('auth'); setLoading(false); }, 3000);
                } catch (e) { setLoading(false); }
            };

            useEffect(() => {
                fetchWeather();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        onValue(ref(rtdb, `artifacts/${appId}/public/data/logs/${CURRENT_BOX_ID}/last_action`), (snap) => {
                            const actualTs = snap.val() || Date.now();
                            setBoxStatus(Math.abs(Date.now() - actualTs) < 65000 ? 'Online' : 'Offline');
                        });
                    } else { signInAnonymously(auth); }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (view !== 'dashboard' || !user || !plate) return;
                const tokensRef = ref(rtdb, `artifacts/${appId}/public/data/telemetry/${CURRENT_BOX_ID}/pending_tokens`);
                
                return onValue(tokensRef, async (snap) => {
                    const tokens = snap.val();
                    if (tokens > 0 && !isProcessingToken.current) {
                        isProcessingToken.current = true;
                        setIsAnimatingCoin(true);
                        setTimeout(() => setIsAnimatingCoin(false), 600);
                        
                        try {
                            const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                            const isCompletingStamp = (sessionProgress + 1 >= TOKENS_PER_STAMP && !hasStampInSession);
                            
                            if (isCompletingStamp) {
                                setShowStampSuccess(true);
                                playSound('SUCCESS');
                            } else {
                                playSound('COIN');
                            }
                            
                            await set(tokensRef, 0); 
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                                numarInmatriculare: cleanPlate, telefon: phone, timestamp: serverTimestamp(),
                                status: "completed", type: isCompletingStamp ? "visit_stamp" : "extra_token_log",
                                box: CURRENT_BOX_ID
                            });
                            await refreshStats(cleanPlate);
                        } finally { 
                            isProcessingToken.current = false; 
                        }
                    }
                });
            }, [view, user, plate, sessionProgress, hasStampInSession, isTestMode]);

            useEffect(() => {
                if (showStampSuccess) {
                    const timer = setTimeout(() => setShowStampSuccess(false), 4000);
                    return () => clearTimeout(timer);
                }
            }, [showStampSuccess]);

            const SmartProtocol = () => {
                if (!weatherData) return null;
                const theme = weatherData[0].rain ? { title: "PROTECȚIE PLOAIE", color: "text-blue-400", icon: "cloud-rain" } : { title: "LUCIU OGLINDĂ", color: "text-emerald-500", icon: "sun" };
                return (
                    <div className="space-y-3 animate-in fade-in duration-700">
                        <div className="glass-panel rounded-2xl p-4 flex items-center justify-between border-l-4 border-emerald-500">
                            <div className="text-left">
                                <div className={`flex items-center gap-2 text-[9px] font-black uppercase tracking-widest mb-1 ${theme.color}`}>
                                    <Icon name={theme.icon} className="w-3 h-3" /> ANALIZĂ METEO
                                </div>
                                <div className="text-3xl font-black italic text-white leading-none">{weatherData[0].temp}°C</div>
                            </div>
                            <div className="text-right opacity-30"><div className="text-[8px] font-bold">MÂINE</div><div className="text-sm font-bold">{weatherData[1].temp}°</div></div>
                        </div>
                        <div className="p-5 glass-panel rounded-[32px] text-left border-white/5 relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-3 opacity-10"><Icon name="shield-check" className="w-12 h-12" /></div>
                            <h4 className={`text-[12px] font-black uppercase mb-3 flex items-center gap-2 ${theme.color}`}>{theme.title}</h4>
                            <div className="flex gap-2 mb-4">
                                {["1","5","3","6","7"].map((s, i) => (
                                    <div key={i} className="w-7 h-7 rounded-lg bg-white/5 text-[10px] flex items-center justify-center font-black border border-white/10">{s}</div>
                                ))}
                            </div>
                            <p className="text-[10px] font-bold text-white/40 italic leading-tight">Protocol optim pentru condițiile curente. Insistă pe protecție.</p>
                        </div>
                    </div>
                );
            };

            return (
                <div className="luxury-bg selection:bg-emerald-500/30 font-outfit h-screen w-full overflow-hidden">
                    <nav className="p-4 flex justify-between items-center w-full max-w-md mx-auto h-[60px] relative z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center shadow-xl"><Icon name="zap" className="text-black w-5 h-5 fill-current" /></div>
                            <div className="flex flex-col text-left leading-none">
                                <span className="font-black italic text-lg uppercase tracking-tighter">MR. <span className="text-emerald-500">WASH</span></span>
                                <span className="text-[5px] font-bold text-white/30 uppercase tracking-[0.5em] mt-0.5">{LOCATION_NAME} ELITE</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {view === 'dashboard' && <button onClick={()=>setIsTestMode(!isTestMode)} className={`w-1.5 h-1.5 rounded-full ${isTestMode ? 'bg-orange-500 animate-pulse' : 'bg-white/10'}`} />}
                            <div className="px-3 py-1 glass-panel rounded-full flex items-center gap-2">
                                <div className={`w-1 h-1 rounded-full live-pulse ${boxStatus==='Online'?'bg-emerald-500':'bg-red-600'}`} />
                                <span className="text-[8px] font-black uppercase text-white/40 italic">{boxStatus}</span>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 px-5 flex flex-col justify-start pt-2 w-full max-w-md mx-auto relative z-10">
                        {view === 'auth' ? (
                            <form onSubmit={handleLogin} className="space-y-10 mt-10 animate-in fade-in slide-in-from-bottom-6 duration-1000">
                                <div className="text-center">
                                    <div className="inline-block px-4 py-1.5 glass-panel rounded-full mb-4 border-emerald-500/20">
                                        <span className="text-[9px] font-black uppercase text-emerald-500 tracking-[0.4em] italic">Loyalty Rewards Program</span>
                                    </div>
                                    <h2 className="text-[55px] font-black italic tracking-tighter uppercase leading-[0.75] text-white">SPALĂ <br /> <span className="text-emerald-500">GRATIS</span></h2>
                                </div>
                                <div className="space-y-3">
                                    <input required placeholder="NR. ÎNMATRICULARE" className="w-full glass-panel rounded-2xl py-6 px-8 text-2xl font-black tracking-widest outline-none text-white uppercase placeholder:text-white/5 border-white/5" value={plate} onChange={e => setPlate(e.target.value)} />
                                    <input required type="tel" placeholder="NUMĂR TELEFON" className="w-full glass-panel rounded-2xl py-6 px-8 text-2xl font-black outline-none text-white border-white/5" value={phone} onChange={e => setPhone(e.target.value)} />
                                </div>
                                <button type="submit" className="w-full btn-premium py-8 rounded-[32px] font-black uppercase text-xs tracking-[0.5em] shadow-2xl">DESCHIDE CARDUL</button>
                            </form>
                        ) : (
                            <div className="space-y-3 animate-in zoom-in-95 duration-700">
                                <div className="glass-panel rounded-[40px] p-6 py-5 space-y-5 text-center relative overflow-hidden">
                                    <div className="flex items-center justify-between">
                                        <div className="text-left leading-none">
                                            <h3 className="text-3xl font-black italic tracking-tighter uppercase text-white leading-none">{plate.toUpperCase()}</h3>
                                            <p className="text-[8px] font-black text-emerald-500/60 uppercase tracking-widest italic mt-1">Elite Status</p>
                                        </div>
                                        <div className="w-10 h-10 glass-panel rounded-xl flex items-center justify-center border-emerald-500/20 bg-emerald-500/5"><Icon name="crown" className="text-emerald-500 w-5 h-5" /></div>
                                    </div>

                                    <div className="flex justify-between gap-2">
                                        {[...Array(5)].map((_, i) => (
                                            <div key={i} className={`w-11 h-11 rounded-[16px] flex items-center justify-center border-2 transition-all duration-700 ${i < userStats.visits ? 'bg-emerald-500 border-emerald-400 text-black shadow-lg shadow-emerald-500/40 scale-105' : (i === 4 ? 'border-emerald-500/40 bg-emerald-500/5' : 'border-white/5 bg-white/5')}`}>
                                                {i < userStats.visits ? <Icon name="check" className="w-6 h-6 stroke-[5]" /> : (i === 4 ? <Icon name="gift" className={`w-6 h-6 ${userStats.nextIsFree ? 'text-emerald-400 animate-bounce' : 'text-emerald-500/10'}`} /> : <span className="text-white/20 font-black text-xl italic leading-none">{i + 1}</span>)}
                                            </div>
                                        ))}
                                    </div>

                                    {showStampSuccess && (
                                        <div className="bg-emerald-500/20 border border-emerald-500/40 rounded-full py-1.5 px-4 flex items-center justify-center gap-2 animate-in slide-in-from-top-3 duration-500 mx-auto w-fit shadow-lg shadow-emerald-500/20">
                                            <Icon name="check-circle" className="text-emerald-500 w-3.5 h-3.5" />
                                            <span className="text-[10px] font-black uppercase text-emerald-500 italic">Ștampilă Adăugată!</span>
                                        </div>
                                    )}

                                    <div className="relative">
                                        {hasStampInSession ? <SmartProtocol /> : (
                                            <div className="flex items-center justify-between gap-6 bg-black/40 p-6 rounded-[35px] border border-white/5 shadow-inner">
                                                <div className="flex-1 text-left">
                                                    <p className="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-1 italic scan-pulse">Scanare Activă Boxa 01</p>
                                                    <div className="token-counter">{sessionProgress}</div>
                                                    <p className="text-[10px] font-bold text-white/30 uppercase mt-2 italic leading-tight">Jetoane în sesiune</p>
                                                </div>
                                                
                                                <div className="relative">
                                                    {isAnimatingCoin && <div className="coin-animation" />}
                                                    <div className={`coin-slot-container ${isAnimatingCoin ? 'active-glow' : ''}`}>
                                                        <div className="coin-entry"></div>
                                                        <div className="mt-2 text-[7px] font-black text-white/20 uppercase tracking-[0.3em]">JETONIERĂ</div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="bg-emerald-500/5 p-4 rounded-2xl border border-emerald-500/10">
                                        <p className="text-[10px] font-black text-white/70 uppercase leading-snug font-outfit">
                                            Introdu minim 5 jetoane in jetoniera.<br/>
                                            <span className="text-emerald-500">Ștampila se bifează automat pe card.</span>
                                        </p>
                                    </div>

                                    <div className="space-y-3">
                                         {userStats.nextIsFree && (
                                             <button onClick={handleRedeem} disabled={loading} className="w-full py-8 bg-emerald-500 text-black rounded-[28px] font-black uppercase text-sm tracking-[0.4em] shadow-2xl animate-pulse">
                                                {loading ? 'ACTIVARE...' : 'ACTIVEAZĂ CADOU'}
                                             </button>
                                         )}
                                         <button onClick={() => set(ref(rtdb, `artifacts/${appId}/public/data/telemetry/${CURRENT_BOX_ID}/pending_tokens`), 1)} className="w-full py-4 glass-panel rounded-2xl flex items-center justify-center gap-3 text-white transition-all shadow-md group border-white/5 active:border-emerald-500/30">
                                            <Icon name="star" className={`w-4 h-4 ${isTestMode ? 'text-orange-500' : 'text-emerald-500/40'}`} />
                                            <span className="text-[11px] font-black uppercase tracking-widest italic text-white/60">
                                                {userStats.nextIsFree ? "Vizită CADOU disponibilă!" : `Mai ai nevoie de ${4 - userStats.visits} vizite!`}
                                            </span>
                                         </button>
                                    </div>
                                </div>
                                <button onClick={() => setView('auth')} className="w-full py-2 text-[8px] font-bold text-white/10 uppercase tracking-[0.4em] flex items-center justify-center gap-2 italic hover:text-white/40"><Icon name="refresh-cw" className="w-2.5 h-2.5 opacity-20" /> Schimbă Mașina</button>
                            </div>
                        )}
                    </main>

                    <footer className="py-2 text-center opacity-5 pointer-events-none mt-auto italic leading-none font-outfit">
                        <p className="text-[8px] font-black uppercase tracking-[1em]">MR. WASH • DRĂGĂNEȘTI-OLT</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
