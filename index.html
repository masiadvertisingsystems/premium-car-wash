<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MR. WASH | ELITE DIVISION</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --emerald: #10b981;
            --emerald-deep: #064e3b;
            --emerald-glow: rgba(16, 185, 129, 0.4);
            --surface: #0a0a0a;
            --border: rgba(255, 255, 255, 0.08);
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
            user-select: none;
        }

        html, body {
            height: 100dvh;
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #fff;
        }

        .app-container {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at 50% -25%, var(--emerald-deep) 0%, #000 85%);
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            overflow: hidden;
            padding: 0 16px;
        }

        .glass-card {
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(35px);
            border: 1px solid var(--border);
            box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            max-height: 82vh;
        }

        .stamp-seal {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1);
            flex-shrink: 0;
        }

        .stamp-seal-empty {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stamp-seal-active {
            background: var(--emerald);
            border: 4px double rgba(0, 0, 0, 0.15);
            box-shadow: 0 0 30px var(--emerald-glow), inset 0 0 15px rgba(0,0,0,0.2);
            transform: scale(1.08) rotate(-8deg);
        }

        @keyframes stamp-target-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); border-color: rgba(255,255,255,0.1); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px var(--emerald-glow); border-color: var(--emerald); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); border-color: rgba(255,255,255,0.1); }
        }
        .stamp-pulse { animation: stamp-target-pulse 2.5s infinite ease-in-out; }

        .gift-seal {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            background: rgba(16, 185, 129, 0.03);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
            flex-shrink: 0;
        }

        .gift-seal-active {
            background: #fff;
            border-color: #fff;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
            color: #000;
        }

        .command-panel {
            background: rgba(16, 185, 129, 0.03);
            border: 1px solid rgba(16, 185, 129, 0.15);
            padding: 24px 20px;
            border-radius: 35px;
            text-align: center;
        }

        .reward-ready-panel {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.02) 100%);
            border: 1px solid var(--emerald);
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.1);
        }

        .font-outfit { font-family: 'Outfit', sans-serif; }

        .token-count {
            font-size: 2.2rem;
            font-weight: 900;
            line-height: 1;
            background: linear-gradient(180deg, #fff 40%, #777 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Outfit', sans-serif;
            font-style: italic;
        }

        .premium-input {
            background: #080808;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            color: #fff;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .debug-panel {
            background: rgba(249, 115, 22, 0.08);
            border: 1px solid rgba(249, 115, 22, 0.3);
            padding: 20px;
            border-radius: 32px;
            margin-top: 10px;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, set, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlzoN9-l_Gvk3ZV2sERlRNQux5QdoSYi4",
            authDomain: "premium-car-wash-systems.firebaseapp.com",
            projectId: "premium-car-wash-systems",
            storageBucket: "premium-car-wash-systems.appspot.com",
            messagingSenderId: "1066804021666",
            appId: "1:1066804021666:web:9494cf947ea14502758afb",
            databaseURL: "https://premium-car-wash-systems-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const auth = getAuth(app);

        const appId = 'premium-car-wash'; 
        const COLLECTION_NAME = 'loyalty';
        const TOKENS_PER_STAMP = 4;
        const DEFAULT_BOX_ID = "OLT_BOX_01"; 

        const Icon = ({ name, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                    window.lucide.createIcons({ portal: containerRef.current });
                }
            }, [name, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center pointer-events-none" />;
        };

        const SuccessView = ({ boxId, onComplete }) => (
            <div className="flex flex-col items-center justify-center min-h-[60dvh] gap-10 text-center animate-in fade-in zoom-in-95 duration-700 px-6">
                <div className="relative shrink-0">
                    <div className="w-40 h-40 bg-emerald-500 rounded-[54px] flex items-center justify-center shadow-[0_0_60px_rgba(16,185,129,0.3)] relative z-10">
                        <Icon name="zap" className="text-black w-20 h-20 fill-current" />
                    </div>
                    <div className="absolute inset-0 bg-emerald-500 rounded-[54px] animate-ping opacity-10" />
                </div>
                
                <div className="space-y-4">
                    <h2 className="text-[54px] sm:text-[64px] font-black italic uppercase tracking-tighter leading-[0.8] font-outfit">
                        SPĂLARE <br/><span className="text-emerald-500 text-[64px] sm:text-[74px]">PORNITĂ!</span>
                    </h2>
                    <div className="space-y-1">
                        <p className="text-white/40 text-[12px] uppercase font-bold tracking-[0.4em] italic leading-relaxed">
                            BOXA {boxId} ACTIVATĂ.
                        </p>
                        <p className="text-emerald-500 font-black uppercase text-[16px] tracking-[0.2em] italic font-outfit">
                            SPOR LA TREABĂ!
                        </p>
                    </div>
                </div>

                <button onClick={onComplete} className="shrink-0 px-10 py-6 bg-white text-black rounded-full text-[13px] font-black uppercase tracking-[0.3em] font-outfit shadow-2xl active:scale-95 transition-all">
                    ÎNAPOI LA CARD
                </button>
            </div>
        );

        const AuthView = ({ plate, setPlate, phone, setPhone, handleLogin, loading }) => (
            <div className="flex flex-col gap-12 py-6 animate-in fade-in duration-1000">
                <div className="space-y-6 text-center mt-4">
                    <h1 className="text-[54px] font-black italic tracking-tighter uppercase leading-[0.85] text-white font-outfit">
                        A 5-A SPĂLARE <br /> <span className="text-emerald-500 text-7xl">E GRATIS</span>
                    </h1>
                    <p className="text-[10px] font-bold uppercase text-white/20 tracking-[0.5em] italic font-outfit">Elite Member Portal • Olt Division</p>
                </div>
                
                <form onSubmit={handleLogin} className="space-y-4">
                    <div className="space-y-3">
                        <input required placeholder="NR. ÎNMATRICULARE" className="w-full premium-input rounded-[28px] py-6 px-8 text-2xl font-black tracking-widest outline-none uppercase font-outfit placeholder:text-white/5" value={plate} onChange={e => setPlate(e.target.value)} />
                        <input required type="tel" placeholder="TELEFON" className="w-full premium-input rounded-[28px] py-6 px-8 text-2xl font-black outline-none font-outfit placeholder:text-white/5" value={phone} onChange={e => setPhone(e.target.value)} />
                    </div>
                    <button type="submit" disabled={loading} className="w-full bg-white text-black py-7 rounded-[32px] font-black uppercase text-[15px] tracking-[0.4em] active:scale-95 transition-all font-outfit shadow-2xl">
                        {loading ? 'Sincronizare...' : 'DESCHIDE CARDUL'}
                    </button>
                </form>
            </div>
        );

        const DashboardView = ({ plate, boxId, boxStatus, userStats, hasStampInSession, sessionProgress, isTestMode, simulateToken, simulateFullCard, setView, onRedeemGift, loading }) => {
            const [showRedeemModal, setShowRedeemModal] = useState(false);

            return (
                <div className="flex flex-col gap-4 animate-in zoom-in-95 duration-500 h-full max-h-full">
                    {showRedeemModal && (
                        <div className="modal-overlay animate-in fade-in duration-300">
                            <div className="bg-zinc-950 border border-white/10 p-10 rounded-[50px] w-full max-w-xs space-y-8 text-center shadow-2xl">
                                <Icon name="gift" className="text-emerald-500 w-16 h-16 mx-auto animate-bounce" />
                                <div className="space-y-2">
                                    <h3 className="text-2xl font-black italic uppercase font-outfit tracking-tighter">CONFIRMĂ UTILIZAREA</h3>
                                    <p className="text-[12px] text-white/30 font-bold uppercase italic leading-tight">Vrei să activezi spălarea gratuită acum la {boxId}?</p>
                                </div>
                                <div className="flex flex-col gap-3">
                                    <button onClick={() => { setShowRedeemModal(false); onRedeemGift(); }} className="w-full py-6 bg-emerald-500 text-black font-black uppercase text-sm tracking-widest rounded-3xl font-outfit">ACTIVEAZĂ ACUM</button>
                                    <button onClick={() => setShowRedeemModal(false)} className="w-full py-4 text-white/20 font-black uppercase text-[10px] tracking-widest font-outfit">ANULEAZĂ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="glass-card rounded-[50px] p-8 relative overflow-hidden flex flex-col gap-6">
                        <div className="flex items-center justify-between relative z-10 shrink-0">
                            <div className="text-left leading-none">
                                <h3 className="text-3xl font-black italic tracking-tighter uppercase font-outfit text-white">{plate.toUpperCase()}</h3>
                                <div className="flex items-center gap-2 mt-2">
                                    <div className={`w-1.5 h-1.5 rounded-full ${boxStatus === 'Online' ? 'bg-emerald-500 shadow-[0_0_12px_#10b981]' : 'bg-red-600'}`} />
                                    <p className="text-[9px] font-bold text-white/30 uppercase tracking-[0.3em] font-outfit italic leading-none">{boxId} • {boxStatus}</p>
                                </div>
                            </div>
                            <div className="w-12 h-12 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center shadow-inner shrink-0"><Icon name="crown" className="text-emerald-500 w-7 h-7" /></div>
                        </div>

                        <div className="flex justify-center items-center gap-3 relative z-10 py-1 shrink-0">
                            {[...Array(5)].map((_, i) => {
                                const isCollected = i < userStats.visits;
                                const isCurrentTarget = i === userStats.visits;
                                return (
                                    <div key={i} className={`
                                        ${i < 4 ? 'stamp-seal' : 'gift-seal'} 
                                        ${isCollected ? 'stamp-seal-active' : 'stamp-seal-empty'}
                                        ${isCurrentTarget && !userStats.nextIsFree ? 'stamp-pulse' : ''}
                                        ${i === 4 && userStats.nextIsFree ? 'gift-seal-active stamp-pulse' : ''}
                                    `}>
                                        {isCollected ? (
                                            <Icon name="check" className="text-black w-7 h-7 stroke-[4]" />
                                        ) : (
                                            i === 4 ? (
                                                <Icon name="gift" className={`w-7 h-7 ${userStats.nextIsFree ? 'text-black animate-bounce' : 'text-emerald-500/10'}`} />
                                            ) : (
                                                <span className="text-white/5 font-black text-xl italic font-outfit leading-none">{i + 1}</span>
                                            )
                                        )}
                                    </div>
                                );
                            })}
                        </div>

                        <div className="flex-1 overflow-y-auto hide-scrollbar flex flex-col gap-4 min-h-0 relative z-10 py-2">
                            {userStats.nextIsFree ? (
                                <div className="command-panel reward-ready-panel py-8 animate-in zoom-in-95 duration-700">
                                    <div className="flex flex-col items-center gap-4">
                                        <div className="w-14 h-14 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg">
                                            <Icon name="gift" className="text-black w-8 h-8" />
                                        </div>
                                        <div className="space-y-1">
                                            <p className="text-[26px] font-black text-white leading-none font-outfit uppercase tracking-tighter italic">
                                                SPĂLARE GRATUITĂ <br/><span className="text-emerald-500">ACTIVĂ PE CARD</span>
                                            </p>
                                            <p className="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] italic mt-2">
                                                Apasă butonul de jos pentru activare
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            ) : hasStampInSession ? (
                                <div className="text-center space-y-4 py-4 animate-in zoom-in-90 duration-700">
                                    <div className="w-16 h-16 bg-emerald-500 rounded-[30px] flex items-center justify-center shadow-3xl shadow-emerald-500/30 mx-auto">
                                        <Icon name="shield-check" className="text-black w-10 h-10" />
                                    </div>
                                    <h4 className="text-2xl font-black italic uppercase text-white font-outfit leading-none tracking-tight">VIZITĂ VALIDATĂ</h4>
                                    <p className="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] font-outfit leading-none italic">Jetoanele extra sunt un răsfăț pentru mașină.</p>
                                </div>
                            ) : (
                                <React.Fragment>
                                    <div className="command-panel shrink-0">
                                        <p className="text-[24px] font-black text-white leading-[1.05] font-outfit uppercase tracking-tighter italic">
                                            {sessionProgress === 0 ? (
                                                <React.Fragment>
                                                    INTRODU MINIM 4 JETOANE <br />
                                                    <span className="text-emerald-500">PENTRU A BIFA ȘTAMPILA.</span>
                                                </React.Fragment>
                                            ) : (
                                                <React.Fragment>
                                                    {sessionProgress === 1 ? 'EXCELENT! ' : 
                                                     sessionProgress === 2 ? 'BRAVO! ' : 
                                                     sessionProgress === 3 ? 'SUPER! ' : ''}
                                                    MAI INTRODU <span className="text-emerald-500">
                                                        {4 - sessionProgress} {4 - sessionProgress === 1 ? 'JETON' : 'JETOANE'}
                                                    </span> <br />
                                                    PENTRU A BIFA ȘTAMPILA.
                                                </React.Fragment>
                                            )}
                                        </p>
                                    </div>
                                    
                                    <div className="flex items-center justify-between px-6 shrink-0">
                                        <div className="flex items-center gap-3 text-white/20">
                                            <Icon name="activity" className="w-3.5 h-3.5 text-emerald-500" />
                                            <span className="text-[9px] font-bold uppercase tracking-widest italic leading-none">Monitorizare live</span>
                                        </div>
                                        <div className="token-count text-white">
                                            {sessionProgress}<span className="text-xs opacity-20 not-italic ml-2 uppercase tracking-[0.2em]">fise</span>
                                        </div>
                                    </div>

                                    {isTestMode && (
                                        <div className="debug-panel space-y-4 animate-in slide-in-from-bottom duration-500">
                                            <div className="flex items-center justify-center gap-2 mb-2">
                                                <Icon name="beaker" className="text-orange-500 w-4 h-4" />
                                                <p className="text-[10px] font-black uppercase text-orange-500 tracking-[0.2em] italic">Telecomandă Debug</p>
                                            </div>
                                            <div className="grid grid-cols-1 gap-2">
                                                <button onClick={() => simulateToken(1)} className="w-full py-4 bg-orange-500/10 border border-orange-500/20 text-orange-400 rounded-2xl font-black uppercase text-[10px] tracking-widest flex items-center justify-center gap-3 active:scale-95 transition-all font-outfit">
                                                    <Icon name="zap" className="w-4 h-4" /> +1 JETON (FISĂ)
                                                </button>
                                                <button onClick={simulateFullCard} disabled={loading} className="w-full py-4 bg-orange-500/20 border border-orange-500/40 text-orange-400 rounded-2xl font-black uppercase text-[10px] tracking-widest flex items-center justify-center gap-3 active:scale-95 transition-all font-outfit">
                                                    <Icon name="check-circle" className="w-4 h-4" /> BIFEAZĂ CARD COMPLET (4/4)
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </React.Fragment>
                            )}
                        </div>

                        <div className="space-y-4 pt-2 shrink-0 relative z-10">
                            <div className="relative">
                                {userStats.nextIsFree ? (
                                    <button onClick={() => setShowRedeemModal(true)} disabled={loading} className="w-full py-7 bg-emerald-500 text-black rounded-[35px] font-black uppercase text-[16px] tracking-[0.4em] shadow-2xl shadow-emerald-500/40 animate-pulse font-outfit active:scale-95">
                                        {loading ? 'Se activează...' : 'ACTIVEAZĂ SPĂLAREA GRATUITĂ'}
                                    </button>
                                ) : (
                                    <div className="w-full py-5 bg-white/5 border border-white/5 rounded-[30px] flex items-center justify-center gap-3 shadow-inner">
                                        <Icon name="gift" className="w-6 h-6 text-emerald-500/20" />
                                        <span className="text-[12px] font-bold uppercase italic text-white/40 tracking-[0.1em] font-outfit leading-none">
                                            Încă {4 - userStats.visits} vizite până la cadou
                                        </span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    <button onClick={() => setView('auth')} className="w-full py-4 text-[10px] font-black text-white/10 uppercase tracking-[0.5em] flex items-center justify-center gap-3 hover:text-white transition-all italic font-outfit shrink-0">
                        <Icon name="refresh-cw" className="w-4 h-4 opacity-20" /> Logout • Schimbă Vehiculul
                    </button>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('auth'); 
            const [plate, setPlate] = useState(localStorage.getItem('pws_plate') || '');
            const [phone, setPhone] = useState(localStorage.getItem('pws_phone') || '');
            const [boxId, setBoxId] = useState(new URLSearchParams(window.location.search).get('box') || DEFAULT_BOX_ID);
            const [boxStatus, setBoxStatus] = useState('...');
            const [userStats, setUserStats] = useState({ visits: 0, nextIsFree: false });
            const [sessionProgress, setSessionProgress] = useState(0);
            const [hasStampInSession, setHasStampInSession] = useState(false);
            const [isTestMode, setIsTestMode] = useState(false);
            const [loading, setLoading] = useState(false);
            const isProcessingToken = useRef(false);

            const refreshStats = async (targetPlate) => {
                if (!auth.currentUser) return;
                try {
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    const q = query(colPath, where("numarInmatriculare", "==", targetPlate.toUpperCase().trim()));
                    const snap = await getDocs(q);
                    
                    const allDocs = snap.docs.map(d => ({
                        ...d.data(), 
                        ts: d.data().timestamp?.toDate()?.getTime() || Date.now()
                    }));
                    
                    const redeemDocs = allDocs.filter(d => d.reward_redeemed === true);
                    const lastRedeemTime = redeemDocs.length > 0 
                        ? Math.max(...redeemDocs.map(d => d.ts)) 
                        : 0;
                    
                    const stamps = allDocs.filter(d => 
                        d.type === 'visit_stamp' && 
                        d.status === 'completed' && 
                        d.ts > lastRedeemTime && 
                        !d.reward_redeemed
                    );
                    
                    const sortedStamps = stamps.sort((a,b) => b.ts - a.ts);
                    const lastStampTime = sortedStamps[0]?.ts || lastRedeemTime;
                    
                    const count = stamps.length;
                    const sessionWindow = isTestMode ? 20000 : 1800000;
                    
                    setHasStampInSession(stamps.some(d => (Date.now() - d.ts) < sessionWindow));
                    
                    const progress = allDocs.filter(d => 
                        d.type === 'extra_token_log' && 
                        d.ts > lastStampTime && 
                        (Date.now() - d.ts) < sessionWindow
                    ).length;

                    setSessionProgress(progress);
                    setUserStats({ 
                        visits: count % 5, 
                        nextIsFree: (count % 5) === 4 
                    });

                } catch (err) {
                    console.error("Refresh Error:", err);
                }
            };

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        onValue(ref(rtdb, `artifacts/${appId}/public/data/logs/${boxId}/last_action`), (snap) => {
                            const ts = snap.val() || Date.now();
                            setBoxStatus(Math.abs(Date.now() - ts) < 65000 ? 'Online' : 'Offline');
                        });
                    } else signInAnonymously(auth);
                });
                return () => unsubscribe();
            }, [boxId]);

            useEffect(() => {
                if (view !== 'dashboard' || !plate) return;
                const tokensRef = ref(rtdb, `artifacts/${appId}/public/data/telemetry/${boxId}/pending_tokens`);
                return onValue(tokensRef, async (snap) => {
                    const tokens = snap.val();
                    if (tokens > 0 && !isProcessingToken.current) {
                        isProcessingToken.current = true;
                        try {
                            const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                            const isCompletingStamp = (sessionProgress + 1 >= TOKENS_PER_STAMP && !hasStampInSession);
                            
                            await set(tokensRef, 0); 
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                                numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(),
                                status: "completed", type: isCompletingStamp ? "visit_stamp" : "extra_token_log",
                                box: boxId
                            });
                            refreshStats(cleanPlate);
                        } finally { isProcessingToken.current = false; }
                    }
                });
            }, [view, plate, sessionProgress, hasStampInSession, boxId]);

            const handleLogin = (e) => {
                if (e) e.preventDefault();
                setLoading(true);
                setView('dashboard');
                refreshStats(plate);
                localStorage.setItem('pws_plate', plate);
                localStorage.setItem('pws_phone', phone);
                setTimeout(() => setLoading(false), 800);
            };

            const simulateToken = (count) => {
                set(ref(rtdb, `artifacts/${appId}/public/data/telemetry/${boxId}/pending_tokens`), count);
            };

            const simulateFullCard = async () => {
                if (loading) return;
                const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                setLoading(true);
                try {
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    for(let i=0; i<4; i++) {
                        await addDoc(colPath, {
                            numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(),
                            status: "completed", type: "visit_stamp", box: "SIM_BOX"
                        });
                    }
                    await refreshStats(cleanPlate);
                } finally { setLoading(false); }
            };

            const handleRedeemGift = async () => {
                if (loading) return;
                setLoading(true);
                try {
                    const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                    
                    await set(ref(rtdb, `artifacts/${appId}/public/data/control/${boxId}/inject_tokens`), 4);
                    
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                        numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(),
                        status: "completed", type: "visit_stamp", reward_redeemed: true, box: boxId
                    });
                    
                    setUserStats({ visits: 0, nextIsFree: false });
                    setSessionProgress(0);

                    setTimeout(() => { 
                        setView('success'); 
                        setLoading(false); 
                    }, 1000);
                } catch (e) { setLoading(false); }
            };

            const backToDashboard = () => {
                const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                refreshStats(cleanPlate); 
                setView('dashboard');
            };

            return (
                <div className="app-container">
                    <nav className="p-6 flex justify-between items-center w-full max-w-md mx-auto shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-emerald-500 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/20"><Icon name="zap" className="text-black w-6 h-6 fill-current" /></div>
                            <span className="font-black italic text-2xl uppercase tracking-tighter leading-none font-outfit text-white">MR. <span className="text-emerald-500 text-3xl">WASH</span></span>
                        </div>
                        <button onClick={() => setIsTestMode(!isTestMode)} className={`p-2.5 rounded-xl border transition-all ${isTestMode ? 'bg-orange-500 text-black border-orange-400' : 'bg-white/5 border-white/10 text-white/10'}`}>
                            <Icon name="beaker" className="w-5 h-5" />
                        </button>
                    </nav>

                    <div className="main-content">
                        {view === 'auth' && (
                            <AuthView plate={plate} setPlate={setPlate} phone={phone} setPhone={setPhone} handleLogin={handleLogin} loading={loading} />
                        )}
                        {view === 'dashboard' && (
                            <DashboardView plate={plate} boxId={boxId} boxStatus={boxStatus} userStats={userStats} hasStampInSession={hasStampInSession} sessionProgress={sessionProgress} isTestMode={isTestMode} simulateToken={simulateToken} simulateFullCard={simulateFullCard} setView={setView} onRedeemGift={handleRedeemGift} loading={loading} />
                        )}
                        {view === 'success' && (
                            <SuccessView boxId={boxId} onComplete={backToDashboard} />
                        )}
                    </div>

                    <footer className="py-6 text-center opacity-5 italic uppercase text-[10px] font-black tracking-[1em] shrink-0 font-outfit text-white mt-auto">
                        MR. WASH • ELITE DIVISION
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
