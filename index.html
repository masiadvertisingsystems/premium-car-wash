<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TEST CLICK | Premium Car Wash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .test-card { background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; }
        .active-stamp { background-color: #0ea5e9; box-shadow: 0 0 15px #0ea5e9; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6">

    <div class="w-full max-w-md text-center mb-8">
        <h1 class="text-3xl font-black uppercase leading-none text-white">
            AI O SPÄ‚LARE <span class="text-sky-500 italic">GRATUITÄ‚!</span>
        </h1>
        <p class="text-slate-400 font-bold mt-2 tracking-widest text-sm">
            SCANEAZÄ‚ ACUM È˜I PROFITÄ‚!
        </p>
    </div>

    <div class="w-full max-w-md test-card rounded-3xl p-8">
        <!-- Vizualizare Progres Test -->
        <div class="flex justify-between mb-8 gap-2">
            <div id="s1" class="w-full aspect-square rounded-xl border-2 border-slate-700 flex items-center justify-center">1</div>
            <div id="s2" class="w-full aspect-square rounded-xl border-2 border-slate-700 flex items-center justify-center">2</div>
            <div id="s3" class="w-full aspect-square rounded-xl border-2 border-slate-700 flex items-center justify-center">3</div>
            <div id="s4" class="w-full aspect-square rounded-xl border-2 border-slate-700 flex items-center justify-center">4</div>
            <div id="s5" class="w-full aspect-square rounded-xl border-2 border-dashed border-amber-500/50 flex items-center justify-center text-amber-500 italic">G</div>
        </div>

        <form id="testForm" class="space-y-4">
            <input type="text" id="plate" placeholder="NR. ÃŽNMATRICULARE (ex: B01ABC)" required
                class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-4 font-bold text-xl uppercase outline-none focus:border-sky-500">
            
            <input type="tel" id="phone" placeholder="TELEFON (ex: 0722...)" required
                class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-4 font-bold outline-none focus:border-sky-500">

            <button type="submit" id="btn" class="w-full bg-white text-black font-black py-5 rounded-xl text-xl hover:bg-sky-500 transition-colors uppercase">
                ActiveazÄƒ Vizita
            </button>
        </form>

        <div id="status" class="mt-6 text-center font-bold text-sm min-h-[1.5rem]"></div>
    </div>

    <script>
        const form = document.getElementById('testForm');
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');

        form.onsubmit = async (e) => {
            e.preventDefault();
            btn.disabled = true;
            btn.innerText = "SE PROCESEAZÄ‚...";
            status.innerText = "";

            const payload = {
                nr_inmatriculare: document.getElementById('plate').value.trim(),
                telefon: document.getElementById('phone').value.trim()
            };

            try {
                // Trimitem catre functia de test din Netlify
                const res = await fetch('/api/pulse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.status === 'success') {
                    updateUI(data.activeStamps, data.isFreeWash);
                    
                    if(data.isFreeWash) {
                        status.innerHTML = `<span class="text-amber-500 uppercase">ðŸ”¥ CLICK ACTIVAT! STATUS: ${data.shellyStatus}</span>`;
                    } else {
                        status.innerHTML = `<span class="text-sky-400">VIZITA ${data.activeStamps}/5 ÃŽNREGISTRATÄ‚</span>`;
                    }
                } else {
                    status.innerHTML = `<span class="text-red-500">EROARE: ${data.error || 'NecunoscutÄƒ'}</span>`;
                }
            } catch (err) {
                status.innerHTML = `<span class="text-red-500">CONEXIUNE EÈ˜UATÄ‚ (NETLIFY/FIREBASE)</span>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "ActiveazÄƒ Vizita";
            }
        };

        function updateUI(stamps, isFree) {
            // Curatam tot
            for(let i=1; i<=4; i++) {
                document.getElementById(`s${i}`).classList.remove('active-stamp', 'border-sky-500');
                document.getElementById(`s${i}`).innerText = i;
            }
            document.getElementById('s5').classList.remove('bg-amber-500', 'text-black');

            // Aplicam progresul
            for(let i=1; i<=stamps; i++) {
                const el = document.getElementById(`s${i}`);
                el.classList.add('active-stamp', 'border-sky-500');
                el.innerText = "âœ“";
            }

            if(isFree) {
                const s5 = document.getElementById('s5');
                s5.classList.add('bg-amber-500', 'text-black', 'border-none');
                s5.innerText = "FREE";
            }
        }
    </script>
</body>
</html>
