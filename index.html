<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MR. WASH | ELITE DIVISION</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --emerald: #10b981;
            --emerald-deep: #064e3b;
            --emerald-glow: rgba(16, 185, 129, 0.4);
            --surface: #0a0a0a;
            --border: rgba(255, 255, 255, 0.08);
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
            user-select: none;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100dvh;
            background-color: #000;
            overflow: hidden; /* Blocare totală scroll */
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #fff;
            position: fixed;
            width: 100%;
        }

        .app-container {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at 50% -25%, var(--emerald-deep) 0%, #000 85%);
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            overflow: hidden;
            padding: 0 16px;
        }

        .glass-card {
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(35px);
            border: 1px solid var(--border);
            box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            flex: 1;
            margin: 5px 0;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .stamp-seal {
            width: clamp(42px, 10vw, 52px);
            height: clamp(42px, 10vw, 52px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1);
            flex-shrink: 0;
        }

        .stamp-seal-empty {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stamp-seal-active {
            background: var(--emerald);
            border: 4px double rgba(0, 0, 0, 0.15);
            box-shadow: 0 0 30px var(--emerald-glow), inset 0 0 15px rgba(0,0,0,0.2);
            transform: scale(1.08) rotate(-8deg);
        }

        @keyframes stamp-target-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); border-color: rgba(255,255,255,0.1); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px var(--emerald-glow); border-color: var(--emerald); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); border-color: rgba(255,255,255,0.1); }
        }
        .stamp-pulse { animation: stamp-target-pulse 2.5s infinite ease-in-out; }

        .gift-seal {
            width: clamp(50px, 12vw, 60px);
            height: clamp(50px, 12vw, 60px);
            border-radius: 18px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            background: rgba(16, 185, 129, 0.03);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
            flex-shrink: 0;
        }

        .gift-seal-active {
            background: #fff;
            border-color: #fff;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
            color: #000;
        }

        .command-panel {
            background: rgba(16, 185, 129, 0.03);
            border: 1px solid rgba(16, 185, 129, 0.15);
            padding: clamp(15px, 3vh, 24px) 20px;
            border-radius: 35px;
            text-align: center;
            flex-shrink: 1;
            min-height: 0;
        }

        .reward-ready-panel {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.02) 100%);
            border: 1px solid var(--emerald);
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.1);
        }

        .font-outfit { font-family: 'Outfit', sans-serif; }

        .token-count {
            font-size: clamp(1.8rem, 5vw, 2.2rem);
            font-weight: 900;
            line-height: 1;
            background: linear-gradient(180deg, #fff 40%, #777 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Outfit', sans-serif;
            font-style: italic;
        }

        .premium-input {
            background: #080808;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            color: #fff;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .debug-panel {
            background: rgba(249, 115, 22, 0.08);
            border: 1px solid rgba(249, 115, 22, 0.3);
            padding: 12px;
            border-radius: 28px;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .legal-link {
            transition: all 0.3s ease;
            cursor: pointer;
            pointer-events: auto;
        }
        .legal-link:hover { color: #fff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, set, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlzoN9-l_Gvk3ZV2sERlRNQux5QdoSYi4",
            authDomain: "premium-car-wash-systems.firebaseapp.com",
            projectId: "premium-car-wash-systems",
            storageBucket: "premium-car-wash-systems.appspot.com",
            messagingSenderId: "1066804021666",
            appId: "1:1066804021666:web:9494cf947ea14502758afb",
            databaseURL: "https://premium-car-wash-systems-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const auth = getAuth(app);

        const appId = 'premium-car-wash'; 
        const COLLECTION_NAME = 'loyalty';
        const TOKENS_PER_STAMP = 4;
        const DEFAULT_BOX_ID = "OLT_BOX_01"; 

        const Icon = ({ name, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                    window.lucide.createIcons({ portal: containerRef.current });
                }
            }, [name, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center pointer-events-none" />;
        };

        const SuccessView = ({ boxId, onComplete }) => (
            <div className="flex flex-col items-center justify-center min-h-[60dvh] gap-8 text-center animate-in fade-in zoom-in-95 duration-700 px-6">
                <div className="relative shrink-0">
                    <div className="w-36 h-36 bg-emerald-500 rounded-[48px] flex items-center justify-center shadow-[0_0_60px_rgba(16,185,129,0.3)] relative z-10">
                        <Icon name="zap" className="text-black w-16 h-16 fill-current" />
                    </div>
                </div>
                
                <div className="space-y-4">
                    <h2 className="text-[48px] font-black italic uppercase tracking-tighter leading-[0.85] font-outfit">
                        SPĂLARE <br/><span className="text-emerald-500 text-[54px]">PORNITĂ!</span>
                    </h2>
                    <p className="text-emerald-500 font-black uppercase text-[14px] tracking-[0.2em] italic font-outfit">
                        SPOR LA TREABĂ!
                    </p>
                </div>

                <button onClick={onComplete} className="px-10 py-6 bg-white text-black rounded-full text-[13px] font-black uppercase tracking-[0.3em] font-outfit shadow-2xl active:scale-95 transition-all">
                    ÎNAPOI LA CARD
                </button>
            </div>
        );

        const AuthView = ({ plate, setPlate, phone, setPhone, handleLogin, loading }) => (
            <div className="flex flex-col gap-8 py-4 animate-in fade-in duration-1000 flex-1 justify-center">
                <div className="space-y-4 text-center">
                    <h1 className="text-[54px] font-black italic tracking-tighter uppercase leading-[0.85] text-white font-outfit">
                        A 5-A SPĂLARE <br /> <span className="text-emerald-500 text-6xl">E GRATIS</span>
                    </h1>
                </div>
                
                <form onSubmit={handleLogin} className="space-y-4">
                    <div className="space-y-3">
                        <input required placeholder="NR. ÎNMATRICULARE" className="w-full premium-input rounded-[28px] py-6 px-8 text-2xl font-black tracking-widest outline-none uppercase font-outfit placeholder:text-white/5" value={plate} onChange={e => setPlate(e.target.value)} />
                        <input required type="tel" placeholder="TELEFON" className="w-full premium-input rounded-[28px] py-6 px-8 text-2xl font-black outline-none font-outfit placeholder:text-white/5" value={phone} onChange={e => setPhone(e.target.value)} />
                    </div>
                    <button type="submit" disabled={loading} className="w-full bg-white text-black py-7 rounded-[32px] font-black uppercase text-[15px] tracking-[0.4em] active:scale-95 transition-all font-outfit shadow-2xl">
                        DESCHIDE CARDUL
                    </button>
                </form>
            </div>
        );

        const DashboardView = ({ plate, boxId, boxStatus, userStats, hasStampInCurrentSession, sessionProgress, isTestMode, simulateToken, simulateFullCard, setView, onRedeemGift, loading }) => {
            const [showRedeemModal, setShowRedeemModal] = useState(false);

            const getLoyaltyPersuasionText = () => {
                if (sessionProgress === 0) {
                    const prefixes = ["BINE AI VENIT!", "VIZITA NR. 2!", "ESTI LA JUMĂTATE!", "ULTIMUL PAS!"];
                    const prefix = prefixes[userStats.visits] || "";
                    return (
                        <React.Fragment>
                            <span className="block text-white/20 text-[10px] tracking-widest mb-1">{prefix}</span>
                            INTRODU MINIM 4 JETOANE <br />
                            <span className="text-emerald-500">PENTRU ȘTAMPILĂ</span>
                        </React.Fragment>
                    );
                } else {
                    const tokenFeedback = ["", "EXCELENT!", "BRAVO!", "SUPER!"];
                    return (
                        <React.Fragment>
                            <span className="block text-emerald-500/40 text-[10px] tracking-widest mb-1 animate-pulse">{tokenFeedback[sessionProgress]}</span>
                            MAI INTRODU <span className="text-emerald-500">
                                {TOKENS_PER_STAMP - sessionProgress} {TOKENS_PER_STAMP - sessionProgress === 1 ? 'JETON' : 'JETOANE'}
                            </span> <br />
                            PENTRU ȘTAMPILĂ
                        </React.Fragment>
                    );
                }
            };

            return (
                <div className="flex flex-col gap-2 animate-in zoom-in-95 duration-500 h-full overflow-hidden">
                    {showRedeemModal && (
                        <div className="modal-overlay">
                            <div className="bg-zinc-950 border border-white/10 p-10 rounded-[50px] w-full max-w-xs space-y-8 text-center shadow-2xl">
                                <Icon name="gift" className="text-emerald-500 w-16 h-16 mx-auto animate-bounce" />
                                <h3 className="text-2xl font-black italic uppercase font-outfit tracking-tighter">DEBLOCHEZI?</h3>
                                <button onClick={() => { setShowRedeemModal(false); onRedeemGift(); }} className="w-full py-6 bg-emerald-500 text-black font-black uppercase text-sm tracking-widest rounded-3xl font-outfit active:scale-95">DA, ACTIVEAZĂ</button>
                                <button onClick={() => setShowRedeemModal(false)} className="w-full py-3 text-white/20 font-black uppercase text-[10px] font-outfit">Anulează</button>
                            </div>
                        </div>
                    )}

                    <div className={`glass-card rounded-[50px] ${isTestMode ? 'p-6 gap-3' : 'p-8 gap-6'}`}>
                        <div className="flex items-center justify-between shrink-0">
                            <div className="text-left leading-none">
                                <h3 className="text-3xl font-black italic tracking-tighter uppercase font-outfit text-white">{plate.toUpperCase()}</h3>
                                <div className="flex items-center gap-2 mt-2">
                                    <div className={`w-1.5 h-1.5 rounded-full ${boxStatus === 'Online' ? 'bg-emerald-500 shadow-[0_0_12px_#10b981]' : 'bg-red-600'}`} />
                                    <p className="text-[9px] font-bold text-white/20 uppercase tracking-[0.3em] font-outfit italic leading-none">{boxId} • {boxStatus}</p>
                                </div>
                            </div>
                            <div className="w-12 h-12 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center shrink-0"><Icon name="crown" className="text-emerald-500 w-7 h-7" /></div>
                        </div>

                        <div className="flex justify-center items-center gap-3 shrink-0">
                            {[...Array(5)].map((_, i) => {
                                const isCollected = i < userStats.visits;
                                const isCurrentTarget = i === userStats.visits;
                                return (
                                    <div key={i} className={`
                                        ${i < 4 ? 'stamp-seal' : 'gift-seal'} 
                                        ${isCollected ? 'stamp-seal-active' : 'stamp-seal-empty'}
                                        ${isCurrentTarget && !userStats.nextIsFree ? 'stamp-pulse' : ''}
                                        ${i === 4 && userStats.nextIsFree ? 'gift-seal-active stamp-pulse' : ''}
                                    `}>
                                        {isCollected ? <Icon name="check" className="text-black w-6 h-6 stroke-[4]" /> : (i === 4 ? <Icon name="gift" className={`w-7 h-7 ${userStats.nextIsFree ? 'text-black' : 'text-emerald-500/10'}`} /> : <span className="text-white/5 font-black text-xl italic font-outfit leading-none">{i + 1}</span>)}
                                    </div>
                                );
                            })}
                        </div>

                        <div className="flex-1 flex flex-col gap-4 min-h-0 justify-center">
                            {userStats.nextIsFree ? (
                                <div className="command-panel reward-ready-panel py-6">
                                    <Icon name="gift" className="text-emerald-500 w-10 h-10 mx-auto mb-2" />
                                    <p className="text-[24px] font-black text-white leading-none font-outfit uppercase tracking-tighter italic">SPĂLARE GRATUITĂ <br/><span className="text-emerald-500">ACTIVĂ PE CARD</span></p>
                                </div>
                            ) : hasStampInCurrentSession ? (
                                <div className="text-center space-y-2">
                                    <Icon name="shield-check" className="text-emerald-500 w-10 h-10 mx-auto" />
                                    <h4 className="text-xl font-black italic uppercase text-white font-outfit leading-none tracking-tight">VIZITĂ VALIDATĂ</h4>
                                </div>
                            ) : (
                                <React.Fragment>
                                    <div className="command-panel">
                                        <p className="text-[22px] font-black text-white leading-[1.05] font-outfit uppercase tracking-tighter italic">
                                            {getLoyaltyPersuasionText()}
                                        </p>
                                    </div>
                                    
                                    <div className="flex items-center justify-between px-6 shrink-0">
                                        <span className="text-[9px] font-bold uppercase tracking-widest italic text-white/20">Monitorizare live</span>
                                        <div className="token-count text-white">
                                            {sessionProgress}<span className="text-xs opacity-20 not-italic ml-2 uppercase">fise</span>
                                        </div>
                                    </div>
                                </React.Fragment>
                            )}

                            {isTestMode && (
                                <div className="debug-panel animate-in slide-in-from-bottom duration-300">
                                    <div className="flex items-center justify-center gap-1 mb-2">
                                        <Icon name="beaker" className="text-orange-500 w-3 h-3" />
                                        <p className="text-[8px] font-black uppercase text-orange-500 tracking-widest italic leading-none">Debug Control</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => simulateToken(1)} className="flex-1 py-3 bg-orange-500/10 border border-orange-500/20 text-orange-400 rounded-xl font-black uppercase text-[9px] tracking-widest font-outfit active:scale-95 transition-all">+1 JETON</button>
                                        <button onClick={simulateFullCard} disabled={loading} className="flex-1 py-3 bg-orange-500/20 border border-orange-500/40 text-orange-400 rounded-xl font-black uppercase text-[9px] tracking-widest font-outfit active:scale-95 transition-all">FULL (4/4)</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="shrink-0 pt-2">
                            {userStats.nextIsFree ? (
                                <button onClick={() => setShowRedeemModal(true)} disabled={loading} className="w-full py-7 bg-emerald-500 text-black rounded-[35px] font-black uppercase text-[15px] tracking-[0.4em] shadow-2xl shadow-emerald-500/40 animate-pulse font-outfit active:scale-95">ACTIVEAZĂ ACUM</button>
                            ) : (
                                <div className="w-full py-5 bg-white/5 border border-white/5 rounded-[30px] flex items-center justify-center gap-3">
                                    <Icon name="lock" className="w-4 h-4 text-white/10" />
                                    <span className="text-[11px] font-bold uppercase italic text-white/20 tracking-[0.1em] font-outfit">Încă {4 - userStats.visits} vizite până la cadou</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('auth'); 
            const [plate, setPlate] = useState(localStorage.getItem('pws_plate') || '');
            const [phone, setPhone] = useState(localStorage.getItem('pws_phone') || '');
            const [boxId, setBoxId] = useState(new URLSearchParams(window.location.search).get('box') || DEFAULT_BOX_ID);
            const [boxStatus, setBoxStatus] = useState('...');
            const [userStats, setUserStats] = useState({ visits: 0, nextIsFree: false });
            const [sessionProgress, setSessionProgress] = useState(0);
            const [hasStampInCurrentSession, setHasStampInCurrentSession] = useState(false);
            const [isTestMode, setIsTestMode] = useState(false);
            const [loading, setLoading] = useState(false);
            const [sessionStartTime, setSessionStartTime] = useState(Date.now());
            const isProcessingToken = useRef(false);

            const refreshStats = async (targetPlate) => {
                if (!auth.currentUser) return;
                try {
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    const q = query(colPath, where("numarInmatriculare", "==", targetPlate.toUpperCase().trim()));
                    const snap = await getDocs(q);
                    const allDocs = snap.docs.map(d => ({ ...d.data(), ts: d.data().timestamp?.toDate()?.getTime() || Date.now() }));
                    const redeemDocs = allDocs.filter(d => d.reward_redeemed === true);
                    const lastRedeemTime = redeemDocs.length > 0 ? Math.max(...redeemDocs.map(d => d.ts)) : 0;
                    const stamps = allDocs.filter(d => d.type === 'visit_stamp' && d.status === 'completed' && d.ts > lastRedeemTime && !d.reward_redeemed);
                    setHasStampInCurrentSession(stamps.some(d => d.ts > sessionStartTime));
                    const sortedStamps = stamps.sort((a,b) => b.ts - a.ts);
                    const lastStampTime = sortedStamps[0]?.ts || lastRedeemTime;
                    const progress = allDocs.filter(d => d.type === 'extra_token_log' && d.ts > lastStampTime && (Date.now() - d.ts) < 1800000).length;
                    setSessionProgress(progress);
                    setUserStats({ visits: stamps.length % 5, nextIsFree: (stamps.length % 5) === 4 });
                } catch (err) { console.error(err); }
            };

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        onValue(ref(rtdb, `artifacts/${appId}/public/data/logs/${boxId}/last_action`), (snap) => {
                            const ts = snap.val() || Date.now();
                            setBoxStatus(Math.abs(Date.now() - ts) < 65000 ? 'Online' : 'Offline');
                        });
                        if (plate) refreshStats(plate);
                    } else signInAnonymously(auth);
                });
                return () => unsubscribe();
            }, [boxId]);

            useEffect(() => {
                if (view !== 'dashboard' || !plate) return;
                const tokensRef = ref(rtdb, `artifacts/${appId}/public/data/telemetry/${boxId}/pending_tokens`);
                return onValue(tokensRef, async (snap) => {
                    const tokens = snap.val();
                    if (tokens > 0 && !isProcessingToken.current) {
                        isProcessingToken.current = true;
                        try {
                            const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                            const isCompletingStamp = (sessionProgress + 1 >= TOKENS_PER_STAMP && !hasStampInCurrentSession);
                            await set(tokensRef, 0); 
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                                numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(),
                                status: "completed", type: isCompletingStamp ? "visit_stamp" : "extra_token_log",
                                box: boxId
                            });
                            refreshStats(cleanPlate);
                        } finally { isProcessingToken.current = false; }
                    }
                });
            }, [view, plate, sessionProgress, hasStampInCurrentSession, boxId]);

            const handleLogin = (e) => {
                if (e) e.preventDefault();
                setLoading(true);
                setSessionStartTime(Date.now()); 
                const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                localStorage.setItem('pws_plate', cleanPlate);
                localStorage.setItem('pws_phone', phone);
                refreshStats(cleanPlate).then(() => { setView('dashboard'); setLoading(false); });
            };

            const simulateToken = (count) => {
                set(ref(rtdb, `artifacts/${appId}/public/data/telemetry/${boxId}/pending_tokens`), count);
            };

            const simulateFullCard = async () => {
                if (loading) return;
                const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                setLoading(true);
                try {
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    for(let i=0; i<4; i++) {
                        await addDoc(colPath, { numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(), status: "completed", type: "visit_stamp", box: "SIM_BOX" });
                    }
                    await refreshStats(cleanPlate);
                } finally { setLoading(false); }
            };

            const handleRedeemGift = async () => {
                if (loading) return;
                setLoading(true);
                try {
                    const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                    await set(ref(rtdb, `artifacts/${appId}/public/data/control/${boxId}/inject_tokens`), 4);
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), { numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(), status: "completed", type: "visit_stamp", reward_redeemed: true, box: boxId });
                    setUserStats({ visits: 0, nextIsFree: false }); setSessionProgress(0);
                    setTimeout(() => { setView('success'); setLoading(false); }, 1000);
                } catch (e) { setLoading(false); }
            };

            return (
                <div className="app-container">
                    <nav className="p-6 flex justify-between items-center w-full max-w-md mx-auto shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-emerald-500 rounded-2xl flex items-center justify-center shadow-lg"><Icon name="zap" className="text-black w-6 h-6 fill-current" /></div>
                            <span className="font-black italic text-2xl uppercase tracking-tighter leading-none font-outfit text-white">MR. <span className="text-emerald-500 text-3xl">WASH</span></span>
                        </div>
                        <button onClick={() => setIsTestMode(!isTestMode)} className={`p-2.5 rounded-xl border transition-all ${isTestMode ? 'bg-orange-500 text-black border-orange-400' : 'bg-white/5 border-white/10 text-white/10'}`}>
                            <Icon name="beaker" className="w-5 h-5" />
                        </button>
                    </nav>

                    <div className="main-content">
                        {view === 'auth' && <AuthView plate={plate} setPlate={setPlate} phone={phone} setPhone={setPhone} handleLogin={handleLogin} loading={loading} />}
                        {view === 'dashboard' && <DashboardView plate={plate} boxId={boxId} boxStatus={boxStatus} userStats={userStats} hasStampInCurrentSession={hasStampInCurrentSession} sessionProgress={sessionProgress} isTestMode={isTestMode} simulateToken={simulateToken} simulateFullCard={simulateFullCard} setView={setView} onRedeemGift={handleRedeemGift} loading={loading} />}
                        {view === 'success' && <SuccessView boxId={boxId} onComplete={() => { setSessionStartTime(Date.now()); refreshStats(plate); setView('dashboard'); }} />}
                    </div>

                    <footer className="py-6 flex flex-col items-center gap-2 mt-auto shrink-0 z-20 relative">
                        <div className="flex items-center gap-6 text-[8px] font-black uppercase tracking-[0.3em] text-white/20 font-outfit">
                            <span className="legal-link">Termeni și Condiții</span>
                            <span className="w-1 h-1 bg-white/5 rounded-full"></span>
                            <span className="legal-link">Politica GDPR</span>
                            <span className="w-1 h-1 bg-white/5 rounded-full"></span>
                            <span onClick={() => setView('auth')} className="legal-link hover:text-emerald-500">Admin Portal</span>
                        </div>
                        <div className="opacity-[0.03] text-[9px] font-black tracking-[1.5em] uppercase pointer-events-none font-outfit">
                            PWS ELITE SYSTEM • BALȘ
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
