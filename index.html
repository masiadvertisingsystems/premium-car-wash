<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MR. WASH | DrƒÉgƒÉne»ôti-Olt</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Plus+Jakarta+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --emerald: #10b981;
            --emerald-soft: rgba(16, 185, 129, 0.1);
            --glass: rgba(10, 10, 10, 0.96);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden; /* BlocƒÉm scroll-ul la nivel de sistem */
        }

        body { 
            color: #ffffff; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }

        .app-container {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: 
                radial-gradient(circle at 50% -10%, #064e3b 0%, transparent 50%),
                #000000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Distribuim elementele pe verticalƒÉ */
            padding: 0 20px;
            overflow: hidden;
        }

        .glass-panel { 
            background: var(--glass); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .font-outfit { font-family: 'Outfit', sans-serif; }

        .token-counter {
            font-size: 2.8rem;
            font-weight: 900;
            font-family: 'Outfit', sans-serif;
            font-style: italic;
            line-height: 1;
            background: linear-gradient(to bottom, #fff, #666);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step-node {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 12px;
            position: relative;
            z-index: 2;
        }

        .step-active {
            background: var(--emerald);
            color: #000;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }

        .step-inactive {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.15);
        }

        .weather-mini-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            padding: 6px 10px;
        }

        .badge-x2 {
            background: #fbbf24;
            color: #000;
            font-size: 8px;
            font-weight: 900;
            padding: 1px 3px;
            border-radius: 3px;
            position: absolute;
            top: -6px;
            right: -6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        @keyframes coin-insert {
            0% { transform: translateY(-15px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(30px); opacity: 0; }
        }
        .coin-animation {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #fbbf24, #b45309);
            border-radius: 50%;
            z-index: 50;
            animation: coin-insert 0.6s ease-in forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, set, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlzoN9-l_Gvk3ZV2sERlRNQux5QdoSYi4",
            authDomain: "premium-car-wash-systems.firebaseapp.com",
            projectId: "premium-car-wash-systems",
            storageBucket: "premium-car-wash-systems.appspot.com",
            messagingSenderId: "1066804021666",
            appId: "1:1066804021666:web:9494cf947ea14502758afb",
            databaseURL: "https://premium-car-wash-systems-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const auth = getAuth(app);

        const appId = 'premium-car-wash'; 
        const COLLECTION_NAME = 'loyalty';
        const TOKENS_PER_STAMP = 5; 
        const weatherApiKey = "5b6ddfa16f49e0e7b271b69d374d902f";
        const CURRENT_BOX_ID = new URLSearchParams(window.location.search).get('box') || "OLT_BOX_01"; 

        const Icon = ({ name, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                    window.lucide.createIcons({ portal: containerRef.current });
                }
            }, [name, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center pointer-events-none" />;
        };

        function App() {
            const [view, setView] = useState('auth');
            const [plate, setPlate] = useState(localStorage.getItem('pws_plate') || '');
            const [phone, setPhone] = useState(localStorage.getItem('pws_phone') || '');
            const [boxStatus, setBoxStatus] = useState('...');
            const [userStats, setUserStats] = useState({ visits: 0, nextIsFree: false });
            const [sessionProgress, setSessionProgress] = useState(0);
            const [hasStampInSession, setHasStampInSession] = useState(false);
            const [weatherData, setWeatherData] = useState(null);
            const [isTestMode, setIsTestMode] = useState(false);
            const [isAnimatingCoin, setIsAnimatingCoin] = useState(false);
            const [forcedWeather, setForcedWeather] = useState(null);
            
            const isProcessingToken = useRef(false);

            const translateWeather = (status) => {
                const dict = { 'Clear': 'Senin', 'Clouds': 'Noros', 'Rain': 'Ploaie', 'Drizzle': 'BurƒÉ', 'Thunderstorm': 'FurtunƒÉ', 'Mist': 'Cea»õƒÉ', 'Fog': 'Cea»õƒÉ', 'Haze': 'P√¢clƒÉ' };
                return dict[status] || 'Variabil';
            };

            const fetchWeather = async () => {
                try {
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=44.17&lon=24.53&units=metric&lang=ro&appid=${weatherApiKey}`);
                    const data = await response.json();
                    if (data && data.list) {
                        setWeatherData([data.list[0], data.list[8]].map((day, i) => ({
                            label: i === 0 ? 'ASTƒÇZI' : 'M√ÇINE',
                            temp: Math.round(day.main.temp),
                            status: day.weather[0].main,
                            text: translateWeather(day.weather[0].main)
                        })));
                    }
                } catch (e) {
                    setWeatherData([{ label: 'ASTƒÇZI', temp: 15, status: 'Clear', text: 'Senin' }, { label: 'M√ÇINE', temp: 18, status: 'Clear', text: 'Senin' }]);
                }
            };

            const refreshStats = async (targetPlate) => {
                if (!auth.currentUser) return;
                try {
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    const q = query(colPath, where("numarInmatriculare", "==", targetPlate.toUpperCase().trim()));
                    const snap = await getDocs(q);
                    const allDocs = snap.docs.map(d => ({...d.data(), ts: d.data().timestamp?.toDate()?.getTime() || Date.now()}));
                    const stamps = allDocs.filter(d => d.type === 'visit_stamp' && d.status === 'completed');
                    const sortedStamps = stamps.sort((a,b) => b.ts - a.ts);
                    const lastStampTime = sortedStamps[0]?.ts || 0;
                    const count = stamps.length % 5;
                    const sessionWindow = isTestMode ? 20000 : 1800000;
                    setHasStampInSession(stamps.some(d => (Date.now() - d.ts) < sessionWindow));
                    const progress = allDocs.filter(d => d.type === 'extra_token_log' && d.ts > lastStampTime && (Date.now() - d.ts) < sessionWindow).length;
                    setSessionProgress(progress);
                    setUserStats({ visits: count, nextIsFree: count === 4 });
                } catch (err) {}
            };

            useEffect(() => {
                fetchWeather();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        onValue(ref(rtdb, `artifacts/${appId}/public/data/logs/${CURRENT_BOX_ID}/last_action`), (snap) => {
                            const ts = snap.val() || Date.now();
                            setBoxStatus(Math.abs(Date.now() - ts) < 65000 ? 'Online' : 'Offline');
                        });
                    } else signInAnonymously(auth);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (view !== 'dashboard' || !plate) return;
                const tokensRef = ref(rtdb, `artifacts/${appId}/public/data/telemetry/${CURRENT_BOX_ID}/pending_tokens`);
                return onValue(tokensRef, async (snap) => {
                    const tokens = snap.val();
                    if (tokens > 0 && !isProcessingToken.current) {
                        isProcessingToken.current = true;
                        setIsAnimatingCoin(true);
                        setTimeout(() => setIsAnimatingCoin(false), 600);
                        try {
                            const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                            const isCompletingStamp = (sessionProgress + 1 >= TOKENS_PER_STAMP && !hasStampInSession);
                            await set(tokensRef, 0); 
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                                numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(),
                                status: "completed", type: isCompletingStamp ? "visit_stamp" : "extra_token_log",
                                box: CURRENT_BOX_ID
                            });
                            refreshStats(cleanPlate);
                        } finally { isProcessingToken.current = false; }
                    }
                });
            }, [view, plate, sessionProgress, hasStampInSession]);

            const SmartProtocol = () => {
                if (!weatherData) return null;
                const current = forcedWeather || weatherData[0].status;
                const recipes = {
                    Clear: { name: "APƒÇ OSMOZATƒÇ", code: "7", icon: "droplet", msg: "Radia»õia UV for»õeazƒÉ depunerea calcarului pe lac. ClƒÉtirea cu apƒÉ osmozatƒÉ asigurƒÉ o uscare impecabilƒÉ." },
                    Clouds: { name: "SUPER SPUMƒÇ", code: "5", icon: "waves", msg: "Lumina difuzƒÉ ascunde contaminan»õii peliculari. Super Spuma Elite garanteazƒÉ decontaminarea totalƒÉ non-contact." },
                    Rain: { name: "SIGILARE CU CEARƒÇ", code: "6", icon: "shield-check", msg: "Ploaia necesitƒÉ barierƒÉ activƒÉ. AplicƒÉ Ceara NanotehnologicƒÉ pentru a genera scutul hidrofob vital." },
                    Atmosphere: { name: "SOLU»öIE JANTE", code: "3", icon: "disc", msg: "Umiditatea atmosfericƒÉ precipitƒÉ praful de fr√¢nƒÉ. Folose»ôte solu»õia activƒÉ pentru protec»õia jantelor." }
                };
                const isAtm = ['Mist', 'Fog', 'Haze'].includes(current);
                const active = isAtm ? recipes.Atmosphere : (recipes[current] || recipes.Clear);

                return (
                    <div className="space-y-2 animate-in fade-in duration-500">
                        <div className="grid grid-cols-2 gap-2">
                            {weatherData.map((d, i) => (
                                <div key={i} className="weather-mini-card flex items-center justify-between">
                                    <div className="leading-none">
                                        <div className="text-[7px] font-black text-white/20 tracking-[0.2em] mb-1">{d.label}</div>
                                        <div className="text-lg font-black italic font-outfit">{d.temp}¬∞C</div>
                                    </div>
                                    <div className="text-right leading-none">
                                        <Icon name={(i===0 && forcedWeather) ? (forcedWeather === 'Clear' ? 'sun' : (forcedWeather === 'Rain' ? 'cloud-rain' : 'cloud')) : (d.status === 'Clear' ? 'sun' : (d.status === 'Rain' ? 'cloud-rain' : 'cloud'))} className="w-3.5 h-3.5 text-emerald-500 mb-1" />
                                        <div className="text-[7px] font-bold text-white/40 uppercase tracking-tighter">{i===0 && forcedWeather ? translateWeather(forcedWeather) : d.text}</div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="p-4 glass-panel rounded-[28px] relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-3 opacity-5"><Icon name={active.icon} className="w-12 h-12" /></div>
                            <div className="text-center relative z-10">
                                <h4 className="text-[8px] font-black uppercase text-white/20 tracking-[0.4em] mb-3 italic">PROTOCOL PROFESIONAL RECOMANDAT</h4>
                                <div className="flex flex-col items-center gap-4">
                                    <div className="relative flex justify-between items-center w-full max-w-[200px]">
                                        <div className="absolute h-[1px] bg-white/5 left-4 right-4 top-1/2 -translate-y-1/2 z-0" />
                                        {["1","5","3","6","7"].map((s, i) => (
                                            <div key={i} className={`step-node ${s === active.code ? 'step-active' : 'step-inactive'}`}>
                                                {s}
                                                {s === active.code && <span className="badge-x2">x2</span>}
                                                {i < 4 && <div className="absolute -right-3 top-1/2 -translate-y-1/2 opacity-10"><Icon name="chevron-right" className="w-2 h-2" /></div>}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="space-y-0.5">
                                        <div className="text-[8px] font-black text-white/30 uppercase tracking-widest italic leading-none">RE»öETA TEHNICƒÇ INCLUDE</div>
                                        <div className="text-lg font-black text-emerald-500 italic font-outfit uppercase tracking-tighter leading-none">{active.name}</div>
                                    </div>
                                </div>
                                <p className="text-[9px] font-medium text-white/50 italic leading-relaxed mt-3 px-1 border-t border-white/5 pt-2">
                                    {active.msg}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            const activateGift = async () => {
                const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                await set(ref(rtdb, `artifacts/${appId}/public/data/control/${CURRENT_BOX_ID}/inject_tokens`), 4);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                    numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(),
                    status: "completed", type: "loyalty_bonus_redeemed", box_redeemed: CURRENT_BOX_ID
                });
                setTimeout(() => refreshStats(cleanPlate), 1000);
            };

            return (
                <div className="app-container">
                    <nav className="p-4 flex justify-between items-center w-full max-w-md mx-auto shrink-0 z-20">
                        <div className="flex items-center gap-2">
                            <div className="w-9 h-9 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg"><Icon name="zap" className="text-black w-6 h-6 fill-current" /></div>
                            <span className="font-black italic text-lg uppercase tracking-tighter leading-none">MR. <span className="text-emerald-500">WASH</span></span>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setIsTestMode(!isTestMode)} className={`p-2 rounded-xl border transition-all ${isTestMode ? 'bg-orange-500 text-black' : 'bg-white/5 border-white/10 text-white/10'}`}><Icon name="beaker" className="w-4 h-4" /></button>
                            <div className="px-3 py-1 glass-panel rounded-full flex items-center gap-1.5 border-white/5">
                                <div className={`w-1.5 h-1.5 rounded-full ${boxStatus==='Online'?'bg-emerald-500 animate-pulse':'bg-red-600'}`} />
                                <span className="text-[8px] font-black uppercase text-white/40 italic">{boxStatus}</span>
                            </div>
                        </div>
                    </nav>

                    <div className="main-content w-full max-w-md mx-auto">
                        {view === 'auth' ? (
                            <form onSubmit={(e) => { e.preventDefault(); setView('dashboard'); refreshStats(plate); }} className="h-full flex flex-col justify-center space-y-8 animate-in fade-in duration-700">
                                <div className="text-center space-y-3">
                                    <div className="inline-block px-4 py-1.5 glass-panel rounded-full border-emerald-500/10"><span className="text-[9px] font-black uppercase text-emerald-500 tracking-[0.3em] italic leading-none">Loyalty Elite Rewards</span></div>
                                    <h2 className="text-[50px] font-black italic tracking-tighter uppercase leading-[0.8] text-white">SPALƒÇ <br /> <span className="text-emerald-500 text-6xl">GRATIS</span></h2>
                                </div>
                                <div className="space-y-3">
                                    <input required placeholder="NR. √éNMATRICULARE" className="w-full bg-[#080808] border-2 border-white/5 rounded-[24px] py-6 px-8 text-2xl font-black tracking-widest outline-none focus:border-emerald-500 text-white uppercase" value={plate} onChange={e => setPlate(e.target.value)} />
                                    <input required type="tel" placeholder="NUMƒÇR TELEFON" className="w-full bg-[#080808] border-2 border-white/5 rounded-[24px] py-6 px-8 text-2xl font-black outline-none focus:border-emerald-500 text-white" value={phone} onChange={e => setPhone(e.target.value)} />
                                </div>
                                <button type="submit" className="w-full bg-white text-black py-7 rounded-[30px] font-black uppercase text-sm tracking-[0.4em] active:scale-95 transition-all">DESCHIDE CARDUL</button>
                            </form>
                        ) : (
                            <div className="h-full flex flex-col justify-between py-2 animate-in zoom-in-95 duration-500">
                                <div className="glass-panel rounded-[36px] p-6 space-y-5 relative overflow-hidden shadow-2xl">
                                    <div className="flex items-center justify-between">
                                        <div className="leading-none">
                                            <h3 className="text-2xl font-black italic tracking-tighter uppercase leading-none font-outfit">{plate.toUpperCase()}</h3>
                                            <p className="text-[9px] font-black text-emerald-500/40 uppercase tracking-widest mt-1.5 italic">Elite Member Olt</p>
                                        </div>
                                        <div className="w-10 h-10 glass-panel rounded-xl flex items-center justify-center border-emerald-500/20 bg-emerald-500/5"><Icon name="crown" className="text-emerald-500 w-5 h-5" /></div>
                                    </div>

                                    <div className="flex justify-between gap-2">
                                        {[...Array(5)].map((_, i) => (
                                            <div key={i} className={`flex-1 h-10 rounded-xl flex items-center justify-center border-2 transition-all duration-700 ${i < userStats.visits ? 'bg-emerald-500 border-emerald-400 text-black shadow-lg scale-105' : (i === 4 ? 'border-emerald-500/40 bg-emerald-500/5' : 'border-white/5 bg-white/5')}`}>
                                                {i < userStats.visits ? <Icon name="check" className="w-6 h-6 stroke-[5]" /> : (i === 4 ? <Icon name="gift" className={`w-5 h-5 ${userStats.nextIsFree ? 'text-emerald-400 animate-bounce' : 'text-emerald-500/10'}`} /> : <span className="text-white/10 font-black text-lg italic">{i + 1}</span>)}
                                            </div>
                                        ))}
                                    </div>

                                    <div className="relative min-h-[110px] flex flex-col justify-center">
                                        {hasStampInSession ? <SmartProtocol /> : (
                                            <div className="flex items-center justify-between gap-4 bg-black/50 p-4 rounded-[28px] border border-white/5 shadow-inner">
                                                <div className="flex-1 leading-none">
                                                    <p className="text-[7px] font-black text-emerald-500 uppercase tracking-widest mb-1.5 italic scan-pulse">SCANARE ACTIVƒÇ BOXA 01</p>
                                                    <div className="token-counter">{sessionProgress}</div>
                                                    <p className="text-[9px] font-bold text-white/20 uppercase mt-2 italic tracking-widest">Jetoane √Ænregistrate</p>
                                                </div>
                                                <div className="relative">
                                                    {isAnimatingCoin && <div className="coin-animation" />}
                                                    <div className="w-18 h-24 bg-zinc-900 border-2 border-zinc-800 rounded-xl flex flex-col items-center justify-center">
                                                        <div className="w-1.5 h-10 bg-black rounded-full border border-zinc-700 shadow-inner" />
                                                        <div className="mt-2 text-[6px] font-black text-white/20 uppercase tracking-widest">JETONIERƒÇ</div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {isTestMode && (
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => set(ref(rtdb, `artifacts/${appId}/public/data/telemetry/${CURRENT_BOX_ID}/pending_tokens`), 1)} className="py-3 bg-orange-500 text-black rounded-xl font-black uppercase text-[8px] tracking-widest flex items-center justify-center gap-1.5"><Icon name="zap" className="w-3 h-3" /> +1 JETON</button>
                                            <div className="flex gap-1">
                                                <button onClick={() => setForcedWeather('Clear')} className="flex-1 py-3 bg-white/5 rounded-lg text-xs">üåû</button>
                                                <button onClick={() => setForcedWeather('Rain')} className="flex-1 py-3 bg-white/5 rounded-lg text-xs">üåßÔ∏è</button>
                                                <button onClick={() => setForcedWeather('Clouds')} className="flex-1 py-3 bg-white/5 rounded-lg text-xs">‚òÅÔ∏è</button>
                                            </div>
                                        </div>
                                    )}

                                    <div className="relative z-10 pt-1">
                                        {userStats.nextIsFree ? (
                                            <button onClick={activateGift} className="w-full py-6 bg-emerald-500 text-black rounded-[24px] font-black uppercase text-[14px] tracking-[0.3em] shadow-xl animate-pulse active:scale-95 transition-all">ACTIVEAZƒÇ CADOU</button>
                                        ) : (
                                            <div className="w-full py-4 glass-panel rounded-[22px] flex items-center justify-center gap-3 text-white border-white/5">
                                                <Icon name="star" className="w-4 h-4 text-emerald-500/40" />
                                                <span className="text-[10px] font-black uppercase italic text-white/50 tracking-wider leading-none">
                                                    Mai ai nevoie de {4 - userStats.visits} vizite
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <button onClick={() => setView('auth')} className="w-full py-2 text-[8px] font-bold text-white/10 uppercase tracking-[0.4em] flex items-center justify-center gap-2 hover:text-white transition-all italic shrink-0"><Icon name="refresh-cw" className="w-2.5 h-2.5 opacity-20" /> Resetare / Logout</button>
                            </div>
                        )}
                    </div>

                    <footer className="py-4 text-center opacity-5 italic uppercase text-[8px] font-black tracking-[0.8em] shrink-0 font-outfit">MR. WASH ‚Ä¢ DRƒÇGƒÇNE»òTI-OLT</footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
