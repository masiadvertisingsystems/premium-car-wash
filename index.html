<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MR. WASH | ELITE DIVISION</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --emerald: #10b981;
            --emerald-dim: #059669;
            --emerald-deep: #022c22;
            --emerald-glow: rgba(16, 185, 129, 0.3);
            --surface: #09090b;
            --border: rgba(255, 255, 255, 0.08);
            --glass: rgba(20, 20, 20, 0.7);
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
            user-select: none;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100dvh;
            background-color: #000;
            overflow: hidden;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #fff;
            position: fixed;
            width: 100%;
        }

        .app-container {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at 50% -20%, #064e3b 0%, #022c22 45%, #000000 90%);
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            overflow: hidden;
            padding: 0 20px;
            position: relative;
            z-index: 10;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.9), 
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            width: 100%;
            border-radius: 44px;
            overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
        }

        .premium-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #fff;
        }
        
        .premium-input:focus {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }

        .premium-input::placeholder {
            color: rgba(255, 255, 255, 0.15);
            font-weight: 500;
        }

        .checkbox-wrapper input:checked + div {
            background-color: var(--emerald);
            border-color: var(--emerald);
            box-shadow: 0 0 15px var(--emerald-glow);
        }
        .checkbox-wrapper input:checked + div svg {
            stroke-dashoffset: 0;
        }
        
        .checkbox-wrapper:active div {
            transform: scale(0.9);
        }

        .stamp-seal {
            width: clamp(44px, 11vw, 54px);
            height: clamp(44px, 11vw, 54px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex-shrink: 0;
        }

        .stamp-seal-empty {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .stamp-seal-active {
            background: var(--emerald);
            border: 3px double rgba(0, 0, 0, 0.2);
            box-shadow: 0 4px 20px var(--emerald-glow), inset 0 2px 5px rgba(255,255,255,0.4);
            transform: scale(1.05) rotate(-5deg);
        }

        .gift-seal {
            width: clamp(52px, 13vw, 64px);
            height: clamp(52px, 13vw, 64px);
            border-radius: 20px;
            border: 1px solid rgba(16, 185, 129, 0.15);
            background: rgba(16, 185, 129, 0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
            flex-shrink: 0;
        }

        .gift-seal-active {
            background: #fff;
            border-color: #fff;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            color: #000;
        }

        .font-outfit { font-family: 'Outfit', sans-serif; }

        .token-count {
            font-size: clamp(2rem, 6vw, 2.5rem);
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(180deg, #fff 30%, #9ca3af 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Outfit', sans-serif;
            letter-spacing: -0.02em;
        }

        .legal-link {
            transition: color 0.3s ease;
            cursor: pointer;
            pointer-events: auto;
        }
        .legal-link:hover { color: var(--emerald); }

        .hide-scrollbar::-webkit-scrollbar { display: none; }

        @keyframes subtle-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.85; transform: scale(0.98); }
        }
        .animate-subtle-pulse { animation: subtle-pulse 3s infinite ease-in-out; }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, set, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlzoN9-l_Gvk3ZV2sERlRNQux5QdoSYi4",
            authDomain: "premium-car-wash-systems.firebaseapp.com",
            projectId: "premium-car-wash-systems",
            storageBucket: "premium-car-wash-systems.appspot.com",
            messagingSenderId: "1066804021666",
            appId: "1:1066804021666:web:9494cf947ea14502758afb",
            databaseURL: "https://premium-car-wash-systems-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const auth = getAuth(app);

        const appId = 'premium-car-wash'; 
        const COLLECTION_NAME = 'loyalty';
        const TOKENS_PER_STAMP = 4; 
        const DEFAULT_BOX_ID = "OLT_BOX_01"; 

        const Icon = ({ name, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                    window.lucide.createIcons({ portal: containerRef.current });
                }
            }, [name, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center pointer-events-none" />;
        };

        const SuccessView = ({ boxId, onComplete }) => (
            <div className="flex flex-col items-center justify-center min-h-[60dvh] gap-8 text-center animate-in fade-in zoom-in-95 duration-700 px-6">
                <div className="relative shrink-0">
                    <div className="w-40 h-40 bg-emerald-500 rounded-[50px] flex items-center justify-center shadow-[0_0_80px_rgba(16,185,129,0.4)] relative z-10 animate-subtle-pulse">
                        <Icon name="zap" className="text-black w-20 h-20 fill-current" />
                    </div>
                </div>
                
                <div className="space-y-4">
                    <h2 className="text-[42px] sm:text-[48px] font-black italic uppercase tracking-tighter leading-[0.9] font-outfit">
                        SPĂLARE <br/><span className="text-emerald-500 text-[50px] sm:text-[56px]">PORNITĂ!</span>
                    </h2>
                    <p className="text-emerald-400 font-bold uppercase text-[13px] tracking-[0.25em] font-outfit opacity-80">
                        SPOR LA TREABĂ!
                    </p>
                </div>

                <button onClick={onComplete} className="px-12 py-5 bg-white text-black rounded-full text-[12px] font-black uppercase tracking-[0.25em] font-outfit shadow-xl hover:shadow-2xl hover:scale-105 active:scale-95 transition-all duration-300">
                    ÎNAPOI LA CARD
                </button>
            </div>
        );

        const AuthView = ({ plate, setPlate, phone, setPhone, handleLogin, loading }) => {
            const [gdprAccepted, setGdprAccepted] = useState(false);

            return (
                <div className="flex flex-col w-full h-full justify-center animate-in fade-in duration-700">
                    <div className="flex flex-col gap-8 sm:gap-12">
                        <div className="text-center space-y-3">
                            <h1 className="text-[40px] sm:text-[52px] font-black italic tracking-tighter uppercase leading-[0.9] text-emerald-500 font-outfit drop-shadow-2xl">
                                AI O SPĂLARE <br/> <span className="text-white">GRATUITĂ!</span>
                            </h1>
                            <div className="flex items-center justify-center gap-3 opacity-60">
                                <div className="h-px w-8 bg-gradient-to-r from-transparent to-white/50"></div>
                                <p className="text-[10px] sm:text-[11px] font-bold text-white uppercase tracking-[0.2em] font-outfit whitespace-nowrap">
                                    După 4 spălări înregistrate
                                </p>
                                <div className="h-px w-8 bg-gradient-to-l from-transparent to-white/50"></div>
                            </div>
                        </div>
                        
                        <form onSubmit={(e) => { e.preventDefault(); if(gdprAccepted) handleLogin(e); }} className="space-y-6">
                            <div className="space-y-4">
                                <div className="relative group">
                                    <div className="absolute left-6 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-emerald-400 transition-colors duration-300">
                                        <Icon name="car-front" className="w-5 h-5" />
                                    </div>
                                    <input 
                                        required 
                                        placeholder="NR. ÎNMATRICULARE" 
                                        className="w-full premium-input rounded-[24px] py-5 pl-14 pr-6 text-xl sm:text-2xl font-black tracking-widest outline-none uppercase font-outfit shadow-lg" 
                                        value={plate} 
                                        onChange={e => setPlate(e.target.value)} 
                                    />
                                </div>
                                
                                <div className="relative group">
                                    <div className="absolute left-6 top-1/2 -translate-y-1/2 text-white/30 group-focus-within:text-emerald-400 transition-colors duration-300">
                                        <Icon name="smartphone" className="w-5 h-5" />
                                    </div>
                                    <input 
                                        required 
                                        type="tel" 
                                        placeholder="TELEFON" 
                                        className="w-full premium-input rounded-[24px] py-5 pl-14 pr-6 text-xl sm:text-2xl font-black outline-none font-outfit tracking-wider shadow-lg" 
                                        value={phone} 
                                        onChange={e => setPhone(e.target.value)} 
                                    />
                                </div>
                            </div>

                            <div 
                                className="flex items-center justify-center gap-3 checkbox-wrapper cursor-pointer py-2 hover:opacity-80 transition-opacity" 
                                onClick={() => setGdprAccepted(!gdprAccepted)}
                            >
                                <input type="checkbox" className="hidden" checked={gdprAccepted} readOnly />
                                <div className={`w-5 h-5 rounded-[6px] border-2 border-white/10 flex items-center justify-center transition-all duration-300 ${gdprAccepted ? 'bg-emerald-500 border-emerald-500 scale-110' : 'bg-transparent'}`}>
                                    <svg className={`w-3.5 h-3.5 text-black stroke-[3] transition-all duration-300 ${gdprAccepted ? 'opacity-100 scale-100' : 'opacity-0 scale-50'}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                                <span className={`text-[10px] font-semibold uppercase tracking-wider font-outfit select-none transition-colors duration-300 ${gdprAccepted ? 'text-white' : 'text-white/40'}`}>
                                    Sunt de acord cu prelucrarea datelor (GDPR)
                                </span>
                            </div>

                            <button 
                                type="submit" 
                                disabled={loading || !gdprAccepted} 
                                className={`w-full py-6 rounded-[28px] font-black uppercase text-[14px] sm:text-[15px] tracking-[0.3em] transition-all duration-300 font-outfit mt-2 border border-transparent
                                ${!gdprAccepted 
                                    ? 'bg-white/5 text-white/10 cursor-not-allowed border-white/5' 
                                    : 'bg-white text-black shadow-[0_0_30px_rgba(255,255,255,0.15)] hover:shadow-[0_0_40px_rgba(255,255,255,0.25)] hover:scale-[1.02] active:scale-[0.98]'}`}
                            >
                                {loading ? 'SE VERIFICĂ...' : 'DESCHIDE CARDUL'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ plate, boxId, boxStatus, userStats, hasStampInCurrentSession, sessionProgress, isTestMode, simulateToken, simulateFullCard, setView, onRedeemGift, loading }) => {
            const [showRedeemModal, setShowRedeemModal] = useState(false);

            const getLoyaltyPersuasionText = () => {
                if (sessionProgress === 0) {
                    const prefixes = ["BINE AI VENIT!", "VIZITA NR. 2!", "EȘTI LA JUMĂTATE!", "ULTIMUL PAS!"];
                    const prefix = prefixes[userStats.visits] || "";
                    return (
                        <div className="flex flex-col gap-1">
                            <span className="text-white/30 text-[9px] font-bold tracking-[0.2em]">{prefix}</span>
                            <span>INTRODU MINIM 4 JETOANE</span>
                            <span className="text-emerald-400">PENTRU VALIDARE SPĂLARE</span>
                        </div>
                    );
                } else {
                    const tokenFeedback = ["", "EXCELENT!", "BRAVO!", "SUPER!"];
                    return (
                        <div className="flex flex-col gap-1">
                            <span className="text-emerald-500 text-[9px] font-bold tracking-[0.2em] animate-pulse">{tokenFeedback[sessionProgress]}</span>
                            <span>MAI INTRODU <span className="text-emerald-400">{TOKENS_PER_STAMP - sessionProgress} {TOKENS_PER_STAMP - sessionProgress === 1 ? 'JETON' : 'JETOANE'}</span></span>
                            <span>PENTRU VALIDARE SPĂLARE</span>
                        </div>
                    );
                }
            };

            return (
                <div className="flex flex-col gap-4 animate-in zoom-in-95 duration-500 h-full overflow-hidden justify-center py-2">
                    {showRedeemModal && (
                        <div className="modal-overlay animate-in fade-in duration-200">
                            <div className="glass-card p-8 w-full max-w-xs space-y-6 text-center shadow-2xl border-white/10 bg-[#09090b]">
                                <div className="w-20 h-20 mx-auto bg-emerald-500/10 rounded-full flex items-center justify-center mb-2">
                                    <Icon name="gift" className="text-emerald-500 w-10 h-10 animate-bounce" />
                                </div>
                                <div className="space-y-2">
                                    <h3 className="text-2xl font-black italic uppercase font-outfit tracking-tighter text-white">DEBLOCHEZI?</h3>
                                    <p className="text-white/40 text-xs font-medium leading-relaxed">Activează acum spălarea gratuită la boxa {boxId}.</p>
                                </div>
                                <div className="space-y-3 pt-2">
                                    <button onClick={() => { setShowRedeemModal(false); onRedeemGift(); }} className="w-full py-5 bg-emerald-500 text-black font-black uppercase text-xs tracking-[0.2em] rounded-2xl font-outfit active:scale-95 hover:bg-emerald-400 transition-colors">DA, ACTIVEAZĂ</button>
                                    <button onClick={() => setShowRedeemModal(false)} className="w-full py-3 text-white/30 font-bold uppercase text-[10px] tracking-widest font-outfit hover:text-white transition-colors">RENUNȚĂ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className={`glass-card ${isTestMode ? 'p-5 gap-4' : 'p-7 gap-6'} relative overflow-hidden`}>
                        <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 blur-[80px] -z-10 pointer-events-none"></div>

                        <div className="flex items-center justify-between shrink-0">
                            <div className="text-left leading-none">
                                <h3 className="text-[28px] sm:text-[32px] font-black italic tracking-tighter uppercase font-outfit text-white drop-shadow-lg">{plate.toUpperCase()}</h3>
                                <div className="flex items-center gap-2 mt-2.5">
                                    <div className={`w-1.5 h-1.5 rounded-full ${boxStatus === 'Online' ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' : 'bg-red-600'}`} />
                                    <p className="text-[9px] font-bold text-white/30 uppercase tracking-[0.2em] font-outfit italic leading-none">{boxId} • {boxStatus}</p>
                                </div>
                            </div>
                            <div className="w-12 h-12 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center shrink-0 shadow-inner backdrop-blur-sm">
                                <Icon name="crown" className="text-emerald-500 w-6 h-6 fill-current/20" />
                            </div>
                        </div>

                        <div className="flex justify-center items-center gap-2 sm:gap-3 shrink-0 py-2">
                            {[...Array(5)].map((_, i) => {
                                const isCollected = i < userStats.visits;
                                const isCurrentTarget = i === userStats.visits;
                                return (
                                    <div key={i} className={`
                                        ${i < 4 ? 'stamp-seal' : 'gift-seal'} 
                                        ${isCollected ? 'stamp-seal-active' : 'stamp-seal-empty'}
                                        ${isCurrentTarget && !userStats.nextIsFree ? 'animate-subtle-pulse border-emerald-500/30' : ''}
                                        ${i === 4 && userStats.nextIsFree ? 'gift-seal-active animate-subtle-pulse' : ''}
                                    `}>
                                        {isCollected ? <Icon name="check" className="text-black w-5 h-5 sm:w-6 sm:h-6 stroke-[4]" /> : (i === 4 ? <Icon name="gift" className={`w-6 h-6 sm:w-7 sm:h-7 ${userStats.nextIsFree ? 'text-black' : 'text-emerald-500/20'}`} /> : <span className="text-white/10 font-black text-lg sm:text-xl italic font-outfit leading-none">{i + 1}</span>)}
                                    </div>
                                );
                            })}
                        </div>

                        <div className="flex-1 flex flex-col gap-4 min-h-0 justify-center relative z-10">
                            {userStats.nextIsFree ? (
                                <div className="flex flex-col items-center justify-center py-6 animate-in zoom-in duration-500 relative">
                                    {/* Glow behind text instead of icon */}
                                    <div className="absolute inset-0 bg-emerald-500/10 blur-[60px] rounded-full pointer-events-none"></div>
                                    
                                    <div className="text-center space-y-4 z-10">
                                        <p className="text-[12px] font-bold text-emerald-500 uppercase tracking-[0.5em] font-outfit animate-pulse">FELICITĂRI!</p>
                                        <h3 className="text-[42px] sm:text-[48px] font-black text-white leading-[0.85] font-outfit uppercase tracking-tighter italic drop-shadow-2xl animate-subtle-pulse">
                                            SPĂLARE <br/> <span className="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-emerald-600">GRATUITĂ</span>
                                        </h3>
                                        <p className="text-[11px] text-white/40 font-medium uppercase tracking-[0.2em] font-outfit pt-2">
                                            Disponibilă la boxa {boxId}
                                        </p>
                                    </div>
                                </div>
                            ) : hasStampInCurrentSession ? (
                                <div className="text-center space-y-3 py-4">
                                    <div className="w-14 h-14 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto border border-emerald-500/20">
                                        <Icon name="shield-check" className="text-emerald-500 w-7 h-7" />
                                    </div>
                                    <div className="space-y-1">
                                        <h4 className="text-lg font-black italic uppercase text-white font-outfit leading-none tracking-wide">SPĂLARE VALIDATĂ</h4>
                                        <p className="text-emerald-500 font-bold uppercase text-[10px] tracking-[0.2em] font-outfit opacity-80">SPOR LA TREABĂ!</p>
                                    </div>
                                </div>
                            ) : (
                                <React.Fragment>
                                    <div className="command-panel">
                                        <div className="text-[18px] sm:text-[20px] font-black text-white leading-[1.1] font-outfit uppercase tracking-tight italic">
                                            {getLoyaltyPersuasionText()}
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center justify-between px-6 py-2 shrink-0 bg-white/5 rounded-3xl border border-white/5">
                                        <span className="text-[9px] font-bold uppercase tracking-widest italic text-white/30 flex items-center gap-2">
                                            <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div> Monitorizare
                                        </span>
                                        <div className="token-count text-white">
                                            {sessionProgress}<span className="text-xs opacity-30 not-italic ml-1.5 uppercase font-bold tracking-wider">fise</span>
                                        </div>
                                    </div>
                                </React.Fragment>
                            )}

                            {isTestMode && (
                                <div className="debug-panel animate-in slide-in-from-bottom duration-300 bg-orange-500/5 border-orange-500/20">
                                    <div className="flex items-center justify-center gap-1.5 mb-2">
                                        <Icon name="beaker" className="text-orange-500 w-3 h-3" />
                                        <p className="text-[8px] font-black uppercase text-orange-500 tracking-widest italic leading-none">Debug Mode</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => simulateToken(1)} className="flex-1 py-3 bg-orange-500/10 border border-orange-500/20 text-orange-400 rounded-xl font-black uppercase text-[9px] tracking-widest font-outfit active:scale-95 transition-all hover:bg-orange-500/20">+1 JETON</button>
                                        <button onClick={simulateFullCard} disabled={loading} className="flex-1 py-3 bg-orange-500/20 border border-orange-500/40 text-orange-400 rounded-xl font-black uppercase text-[9px] tracking-widest font-outfit active:scale-95 transition-all hover:bg-orange-500/30">FULL (4/4)</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="shrink-0 pt-2">
                            {userStats.nextIsFree ? (
                                <button onClick={() => setShowRedeemModal(true)} disabled={loading} className="w-full py-6 bg-emerald-500 text-black rounded-[28px] font-black uppercase text-[14px] tracking-[0.3em] shadow-[0_0_30px_rgba(16,185,129,0.4)] animate-subtle-pulse font-outfit active:scale-95 hover:bg-emerald-400 transition-colors">ACTIVEAZĂ ACUM</button>
                            ) : (
                                <div className="w-full py-5 bg-white/5 border border-white/5 rounded-[28px] flex items-center justify-center gap-3">
                                    <Icon name="lock" className="w-4 h-4 text-white/20" />
                                    <span className="text-[11px] font-bold uppercase italic text-white/30 tracking-[0.1em] font-outfit">A 5-a spălare GRATUITĂ</span>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <button onClick={() => setView('auth')} className="w-full py-4 text-[10px] font-bold text-white/20 uppercase tracking-[0.4em] flex items-center justify-center gap-2 hover:text-white transition-colors italic font-outfit shrink-0 group">
                        <Icon name="refresh-cw" className="w-3.5 h-3.5 opacity-40 group-hover:opacity-100 transition-opacity" /> Logout • Schimbă
                    </button>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('auth'); 
            const [plate, setPlate] = useState(localStorage.getItem('pws_plate') || '');
            const [phone, setPhone] = useState(localStorage.getItem('pws_phone') || '');
            const [boxId, setBoxId] = useState(new URLSearchParams(window.location.search).get('box') || DEFAULT_BOX_ID);
            const [boxStatus, setBoxStatus] = useState('...');
            const [userStats, setUserStats] = useState({ visits: 0, nextIsFree: false });
            const [sessionProgress, setSessionProgress] = useState(0);
            const [hasStampInCurrentSession, setHasStampInCurrentSession] = useState(false);
            const [isTestMode, setIsTestMode] = useState(false);
            const [loading, setLoading] = useState(false);
            const [sessionStartTime, setSessionStartTime] = useState(Date.now());
            const isProcessingToken = useRef(false);

            const refreshStats = async (targetPlate) => {
                if (!auth.currentUser) return;
                try {
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    const q = query(colPath, where("numarInmatriculare", "==", targetPlate.toUpperCase().trim()));
                    const snap = await getDocs(q);
                    const allDocs = snap.docs.map(d => ({ ...d.data(), ts: d.data().timestamp?.toDate()?.getTime() || Date.now() }));
                    const redeemDocs = allDocs.filter(d => d.reward_redeemed === true);
                    const lastRedeemTime = redeemDocs.length > 0 ? Math.max(...redeemDocs.map(d => d.ts)) : 0;
                    const stamps = allDocs.filter(d => d.type === 'visit_stamp' && d.status === 'completed' && d.ts > lastRedeemTime && !d.reward_redeemed);
                    setHasStampInCurrentSession(stamps.some(d => d.ts > sessionStartTime));
                    const sortedStamps = stamps.sort((a,b) => b.ts - a.ts);
                    const lastStampTime = sortedStamps[0]?.ts || lastRedeemTime;
                    const progress = allDocs.filter(d => d.type === 'extra_token_log' && d.ts > lastStampTime && (Date.now() - d.ts) < 1800000).length;
                    setSessionProgress(progress);
                    setUserStats({ visits: stamps.length % 5, nextIsFree: (stamps.length % 5) === 4 });
                } catch (err) { console.error(err); }
            };

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        const logsPath = `artifacts/${appId}/public/data/logs/${boxId}/last_action`;
                        onValue(ref(rtdb, logsPath), (snap) => {
                            const ts = snap.val() || Date.now();
                            setBoxStatus(Math.abs(Date.now() - ts) < 65000 ? 'Online' : 'Offline');
                        });
                        if (plate) refreshStats(plate);
                    } else signInAnonymously(auth);
                });
                return () => unsubscribe();
            }, [boxId]);

            useEffect(() => {
                if (view !== 'dashboard' || !plate) return;
                const tokensRef = ref(rtdb, `artifacts/${appId}/public/data/telemetry/${boxId}/pending_tokens`);
                return onValue(tokensRef, async (snap) => {
                    const tokens = snap.val();
                    if (tokens > 0 && !isProcessingToken.current) {
                        isProcessingToken.current = true;
                        try {
                            const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                            const isCompletingStamp = (sessionProgress + 1 >= TOKENS_PER_STAMP && !hasStampInCurrentSession);
                            await set(tokensRef, 0); 
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                                numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(),
                                status: "completed", type: isCompletingStamp ? "visit_stamp" : "extra_token_log",
                                box: boxId
                            });
                            refreshStats(cleanPlate);
                        } finally { isProcessingToken.current = false; }
                    }
                });
            }, [view, plate, sessionProgress, hasStampInCurrentSession, boxId]);

            const handleLogin = (e) => {
                if (e) e.preventDefault();
                setLoading(true);
                setSessionStartTime(Date.now()); 
                const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                localStorage.setItem('pws_plate', cleanPlate);
                localStorage.setItem('pws_phone', phone);
                refreshStats(cleanPlate).then(() => { setView('dashboard'); setLoading(false); });
            };

            const simulateToken = (count) => {
                set(ref(rtdb, `artifacts/${appId}/public/data/telemetry/${boxId}/pending_tokens`), count);
            };

            const simulateFullCard = async () => {
                if (loading) return;
                const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                setLoading(true);
                try {
                    const colPath = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    for(let i=0; i<4; i++) {
                        await addDoc(colPath, { numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(), status: "completed", type: "visit_stamp", box: "SIM_BOX" });
                    }
                    await refreshStats(cleanPlate);
                } finally { setLoading(false); }
            };

            const handleRedeemGift = async () => {
                if (loading) return;
                setLoading(true);
                try {
                    const cleanPlate = plate.toUpperCase().replace(/\s/g, '');
                    await set(ref(rtdb, `artifacts/${appId}/public/data/control/${boxId}/inject_tokens`), 4);
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), { numarInmatriculare: cleanPlate, phone, timestamp: serverTimestamp(), status: "completed", type: "visit_stamp", reward_redeemed: true, box: boxId });
                    setUserStats({ visits: 0, nextIsFree: false }); setSessionProgress(0);
                    setTimeout(() => { setView('success'); setLoading(false); }, 1000);
                } catch (e) { setLoading(false); }
            };

            return (
                <div className="app-container">
                    <nav className="p-5 sm:p-6 flex justify-between items-center w-full max-w-md mx-auto shrink-0 z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 sm:w-10 sm:h-10 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20"><Icon name="zap" className="text-black w-5 h-5 sm:w-6 sm:h-6 fill-current" /></div>
                            <span className="font-black italic text-xl sm:text-2xl uppercase tracking-tighter leading-none font-outfit text-white drop-shadow-md">MR. <span className="text-emerald-500 text-2xl sm:text-3xl">WASH</span></span>
                        </div>
                        <button onClick={() => setIsTestMode(!isTestMode)} className={`p-2.5 rounded-xl border transition-all duration-300 ${isTestMode ? 'bg-orange-500 text-black border-orange-400' : 'bg-white/5 border-white/10 text-white/20 hover:bg-white/10'}`}>
                            <Icon name="beaker" className="w-5 h-5" />
                        </button>
                    </nav>

                    <div className="main-content">
                        {view === 'auth' && <AuthView plate={plate} setPlate={setPlate} phone={phone} setPhone={setPhone} handleLogin={handleLogin} loading={loading} />}
                        {view === 'dashboard' && <DashboardView plate={plate} boxId={boxId} boxStatus={boxStatus} userStats={userStats} hasStampInCurrentSession={hasStampInCurrentSession} sessionProgress={sessionProgress} isTestMode={isTestMode} simulateToken={simulateToken} simulateFullCard={simulateFullCard} setView={setView} onRedeemGift={handleRedeemGift} loading={loading} />}
                        {view === 'success' && <SuccessView boxId={boxId} onComplete={() => { setSessionStartTime(Date.now()); refreshStats(plate); setView('dashboard'); }} />}
                    </div>

                    <footer className="py-6 flex flex-col items-center gap-2 mt-auto shrink-0 z-20 relative">
                        <div className="flex items-center gap-6 text-[8px] font-black uppercase tracking-[0.3em] text-white/20 font-outfit">
                            <span className="legal-link">Termeni și Condiții</span>
                            <span className="w-1 h-1 bg-white/5 rounded-full"></span>
                            <span className="legal-link">Politica GDPR</span>
                            <span className="w-1 h-1 bg-white/5 rounded-full"></span>
                            <span onClick={() => setView('auth')} className="legal-link hover:text-emerald-500 transition-colors">Admin Portal</span>
                        </div>
                        <div className="opacity-[0.05] text-[9px] font-black tracking-[1.5em] uppercase pointer-events-none font-outfit mt-2">
                            PWS ELITE SYSTEM • BALȘ
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
